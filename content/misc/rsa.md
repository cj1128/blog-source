---
title: RSA 的原理与实现
date: 2019-10-03T07:19:07+08:00
cover: http://asset.cjting.cn/FlHruid2di9QJ-HK0CTL0OeL6pNM.jpg
draft: true
---

1976 年以前，所有的加密都是如下方式：

- A 使用某种规则对信息进行处理
- B 使用同样的规则对处理过的信息进行复原

这个方式很好理解，不论是非常简单的 ROT13 还是目前广泛使用的 AES，都是这种对称加密方式。

但是这种方式有一个巨大的缺点，那就是 A 需要将对信息进行处理的规则（也就是秘钥）告诉给 B，怎样安全地传输秘钥就成了一个非常棘手的问题。

那么存不存在一种方式，加密和解密使用不同的秘钥，彻底规避掉传输秘钥的问题？

答案是存在的，感谢数学家和计算机学家，RSA 就是这样一种非对称加密方式，也就是：

- 使用算法可以生成两把钥匙，一把为私钥，一把为公钥
- 公钥公开发布，任何人都可以获取，私钥自己保留
- 使用公钥加密的信息，使用私钥可以解开

这样我们只要把私钥保存好，这个通信系统就非常安全。

<!--more-->

寻找大的质数。
https://zh.wikipedia.org/wiki/AKS%E8%B3%AA%E6%95%B8%E6%B8%AC%E8%A9%A6


整数分解为什么困难。
https://zh.wikipedia.org/wiki/%E6%95%B4%E6%95%B0%E5%88%86%E8%A7%A3


计算 e。
https://zh.wikipedia.org/wiki/%E6%89%A9%E5%B1%95%E6%AC%A7%E5%87%A0%E9%87%8C%E5%BE%97%E7%AE%97%E6%B3%95

为什么教科书的 RSA 不安全？为什么需要 Padding。
https://crypto.stackexchange.com/questions/20085/which-attacks-are-possible-against-raw-textbook-rsa

## 数学原理

现在我们来看看这样一个神奇的系统背后的数学原理，数学作为人类智慧皇冠上最灿烂的明珠，永远是那么的冷静迷人。这里我只陈述内容，具体的证明如果感兴趣可以 Google。

首先我们梳理几个概念。

**互质**

如果两个正整数，除了 1 以外没有其他的公因数，则他们互质。比如，14 和 15 互质。注意，两个数构成互质关系，不一定需要是质数。

**欧拉函数**

$$
\phi(n) = n (1 - \frac{1}{p_1}) (1 - \frac{1}{p_2})...(1 - \frac{1}{p_n})
$$

欧拉函数用于计算任意正整数 n，在 <=n 的正整数中，与 n 互质的正整数个数，其中 $\phi(1) = 1$。

其中，$p_1$，$p_2$ 表示 n 的质因子，重复的只算一个。

例如，$10 = 2 \times 5$，所以 $\phi(10) = 10 (1- \frac12) (1 - \frac15) = 4$，意味着在 <=10 的正整数中，与 10 互质的正整数个数为 4 个。我们可以验证一下，他们分别是 1, 3, 7, 9，一共 4 个。

再例如，$12 = 2 \times 2 \times 3$，所以 $\phi(12) = 12 (1 - \frac12) (1 - \frac13) = 4$。

**欧拉定理和费马小定理**

欧拉定理是说：如果两个正整数 a 和 n 互质，则如下等式成立：

$$
a^{\phi(n)} \equiv 1 \pmod n
$$

换句话说，$a^{\phi(n)}$ 减去 1，可以整除 n。

例如，7 和 10 互质，$7^{\phi(10)} = 7^4 = 2401$，减去 1 等于 2400，可以整除 10。

同样的道理，$10^{\phi(7)} = 10^6 = 1000000$，减去 1 等于 999999，可以整除 7。

欧拉定理存在一个特殊情况，如果 p 是个质数的话，因为 $\phi(p) = p - 1$，所以

$$
a^{p - 1} \equiv 1 \pmod p
$$

这就是费马小定理，它是欧拉定理的特例。

**模反元素**

如果两个正整数 a 和 n 互质，那么一定可以找到一个正整数 b，使得 ab - 1 被 n 整除。

$$
ab \equiv 1 \mod n
$$

这个时候，b 就叫做 a 的模反元素。

比如，3 和 11 互质，3 的模反元素是 4，因为 $(3 \times 4) - 1$ 可以整除 11。

我们可以发现，模反元素不止一个，4 加减 11 的倍数都是 3 的模反元素。

我们可以用欧拉定理来证明，模反元素一定存在。

$$
a^{\phi(n)} = a \times a^{\phi(n) - 1} \equiv 1 \pmod n
$$

可以看出，$a^{\phi(n) - 1}$ 就是 a 的模反元素。

好了，到此为止，需要的数学知识就全部介绍完毕了。

## 秘钥生成

接下来我们来看秘钥生成的步骤。

第一步，随机选择两个大质数 p 和 q，并计算他们的乘机 n。一般来说，n 要求换算成二进制要大于 2048 位。

这里因为是演示，我们使用比较小的数，选择 p = 3 以及 q = 7，所以 n = 21。

第二步，计算 n 的欧拉函数 $\phi(n)$。

根据公式，我么可以得知 $\phi(21) = 12$。

第三步，选择一个数 e 使得 e 与 $\phi(n)$ 互质。

在日常应用中，我们一般选择 65537，选择一个已知的数字不会降低 RSA 的安全性。

这里，我们选择 e = 5。

最后一步，计算 e 相对 $\phi(n)$ 的模反元素 d。

因为 

$$
ed \equiv 1 \pmod \phi(n)
$$

这个式子等价于

$$
ed - 1 = k\phi(n)
$$

找到 d 实际上就是求解如下的二元一次方程：

$$
ex + y\phi(n) = 1
$$

已知， e = 5，$\phi(n)$ = 12，带入得到：

$$
5x + 12y = 1
$$

这个方程可以使用 [扩展欧几里得算法] 求解，我们可以得到一组解 x = 17 和 y = -7。所以， d = 17。

到这里计算完毕，公钥就是 $[n, e]$，私钥就是 $[n, d]$。

## 加密和解密

现在我们来看看加密和解密过程是怎样的。

加密消息 m 需要是一个小于 n 的整数（我们可以将任意字节流直接解读为一个无符号整数）。

加密的过程，就是计算如下的 c。

$$
m^e \equiv c \pmod n
$$

我们的公钥是 $[21, 5]$，假设我们的消息是 10。

$$
10^5 \equiv 19 \pmod {21}
$$

c  = 19，所以加密以后的消息就是 19。

后面我们会证明，下面的等式一定成立：

$$
c^d \equiv m \pmod n
$$

所以，解密只要使用私钥 $[n, d]$，对 c 进行运算即可。

我们的私钥是 $[21, 17]$。

$$
19^{17} \equiv 10 \pmod {21}
$$

解密得出原始消息 10。

## 解密证明

现在我们来证明为什么如下等式一定成立。

$$
c^d \equiv m \pmod n
$$

因为 

$$
m^e \equiv c \pmod n
$$

所以，c 可以写为 $$c = m^e - kn$$。

将 c 代入得到

$$
(m^e - kn)^d \equiv m \pmod n
$$

根据二项式定理，左边展开后的每一项，除了 $m^{ed}$ 以外，都含有 $kn$，因此，证明上面的式子等同于证明

$$
m^{ed} \equiv m \pmod n
$$

由于

$$
ed \equiv 1 \pmod \phi(n)
$$

所以，$ed = 1 + h\phi(n)$，代入得到

$$
m^{h\phi(n) + 1} \equiv m \pmod n
$$

我们来分两种情况证明。


1、如果 m 和 n 互质

根据欧拉定理，我们可以得到

$$
m^{\phi(n)} \equiv 1 \pmod n
$$

所以

$$
(m^{\phi(n)})^h \times m \equiv m \pmod n
$$

原式得到证明。

2、如果 m 和 n 不互质

因为 n 是质数 p 和 q 的乘积，此时 m 必然为 kp 或者 kq。

这里我们假设 m = kp，此时 k 必然与 q 互质，因为 k 不可能是 q 的倍数，所以 kp 与 q 互质，得到

$$
kp^{q - 1} \equiv 1 \pmod q
$$

进一步可以得到

$$
[kp^{q - 1}]^{h(p - 1)} \times kp \equiv kp \pmod q
$$

## 可靠性

## 秘钥格式

一般我们使用 RSA 都是通过 `ssh-keygen` 指令来生成公钥和私钥，默认保存目录为 `~/.ssh/id_rsa` 和 `~/.ssh/id_rsa.pub`。

## Go 语言实现

m 必须是一个小于 n 的整数。

padding。

## 参考

- http://www.ruanyifeng.com/blog/2013/06/rsa_algorithm_part_one.html
- https://eli.thegreenplace.net/2019/rsa-theory-and-implementation/

[扩展欧几里得算法]: https://zh.wikipedia.org/wiki/%E6%89%A9%E5%B1%95%E6%AC%A7%E5%87%A0%E9%87%8C%E5%BE%97%E7%AE%97%E6%B3%95
