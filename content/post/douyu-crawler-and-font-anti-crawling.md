---
title: æ–—é±¼å…³æ³¨äººæ•°çˆ¬å– â”€â”€ å­—ä½“åçˆ¬çš„æ”»ä¸é˜²
date: 2020-07-01T23:47:32+08:00
tags: [js crawler]
cover: http://asset.cjting.cn/FuVqI-ejvbgBEDfa4NxH6sjjzb0o.jpg
---

ä¹‹å‰å› ä¸ºä¸šåŠ¡åŸå› éœ€è¦çˆ¬å–ä¸€æ‰¹æ–—é±¼ä¸»æ’­çš„ç›¸å…³æ•°æ®ï¼Œåœ¨è¿™è¿‡ç¨‹ä¸­æˆ‘å‘ç°æ–—é±¼ä½¿ç”¨äº†ä¸€ç§å¾ˆæœ‰æ„æ€çš„åçˆ¬æŠ€æœ¯ï¼Œå­—ä½“åçˆ¬ã€‚

æ‰“å¼€ä»»ä½•ä¸€ä¸ªæ–—é±¼ä¸»æ’­çš„ç›´æ’­é—´ï¼Œä¾‹å¦‚ [è¿™ä¸ªä¸»æ’­](https://www.douyu.com/7874579)ï¼Œä»–çš„å…³æ³¨äººæ•°æ•°æ®æ˜¾ç¤ºåœ¨å³ä¸Šè§’ï¼š

![](http://asset.cjting.cn/Fp11DQiiqvE_vQddpXH1tgazywrA.png)

æ–—é±¼åœ¨å…³æ³¨æ•°æ®è¿™é‡Œä½¿ç”¨äº†å­—ä½“åçˆ¬ã€‚ä»€ä¹ˆæ˜¯å­—ä½“åçˆ¬ï¼Ÿä¹Ÿå°±æ˜¯é€šè¿‡è‡ªå®šä¹‰å­—ä½“æ¥è‡ªå®šä¹‰å­—ç¬¦ä¸æ¸²æŸ“å›¾å½¢çš„æ˜ å°„ã€‚æ¯”å¦‚ï¼Œå­—ç¬¦ 1 å®é™…æ¸²æŸ“çš„æ˜¯ 9ï¼Œé‚£ä¹ˆå¦‚æœ HTML ä¸­çš„æ•°å­—æ˜¯ 111ï¼Œå®é™…æ˜¾ç¤ºå°±æ˜¯ 999ã€‚

åœ¨è¿™ç§æŠ€æœ¯ä¸‹ï¼Œä¼ ç»Ÿçš„é€šè¿‡è§£æ HTML æ–‡æ¡£è·å–æ•°æ®çš„æ–¹å¼å°±å¤±æ•ˆäº†ï¼Œå› ä¸ºè·å–åˆ°çš„æ•°æ®å¹¶ä¸æ˜¯çœŸå®æ•°æ®ã€‚

<!--more-->

{{% tip %}}
ä¸‹æ–‡ä¸­æ‰€è°ˆçš„å…·ä½“ç»†èŠ‚é«˜åº¦ä¾èµ–æ–—é±¼ç½‘é¡µçš„å®ç°ï¼Œå¾ˆæœ‰å¯èƒ½å½“ä½ é˜…è¯»è¿™ç¯‡æ–‡ç« çš„æ—¶å€™å·²ç»ä¸å†æ˜¯é‚£æ ·ã€‚è™½ç„¶ä»£ç ä¼šè¿‡æ—¶åœ°å¾ˆå¿«ï¼Œä½†æ˜¯ï¼ŒæŠ€å·§å’Œæ–¹æ³•æ˜¯æ°¸è¿œä¸ä¼šè¿‡æ—¶çš„ã€‚
{{% /tip %}}

## è¿›æ”»

æ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥æ‰“å¼€æ§åˆ¶å°ï¼Œçœ‹çœ‹æ˜¾ç¤ºå…³æ³¨äººæ•°çš„é‚£ä¸ª span å…ƒç´ é‡Œé¢çš„å†…å®¹ï¼Œä¼šå‘ç°æ ¹æœ¬ä¸æ˜¯æ˜¾ç¤ºçš„æ•°å­—ã€‚

![](http://asset.cjting.cn/Fta2MA78inWQx-YXBJsQ-9dWh3Br.png)

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œæ˜¾ç¤ºçš„æ˜¯ 59605ï¼Œè¿™ä¸ªæ˜¯çœŸå®å€¼ï¼Œä½†æ˜¯å­—ç¬¦å´æ˜¯ 96809ï¼Œè¿™ä¸ªæ˜¯è™šå‡å€¼ã€‚å³è¾¹çš„ `font-family` å‘Šè¯‰æˆ‘ä»¬è¿™ä¸ªå…ƒç´ ä½¿ç”¨äº†ä¸€ä¸ªè‡ªå®šä¹‰å­—ä½“ã€‚

ä» Network é¢æ¿ä¸­çš„æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°è¿™ä¸ªå­—ä½“ï¼Œå…·ä½“é“¾æ¥æ˜¯ [mpepc5unpb.woff](https://shark.douyucdn.cn/app/douyu/res/font/mpepc5unpb.woff)ã€‚

å¦‚æœå¤§å®¶å°†å­—ä½“ä¸‹è½½ä¸‹æ¥ï¼Œä½¿ç”¨å¦‚ä¸‹çš„ HTML ä»£ç æ¥æ¸²æŸ“å®ƒï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹å¾—å¾ˆæ¸…æ¥šï¼š

```html
<!DOCTYPE html>
<html>
<head>
  <style type="text/css">
    @font-face {
      font-family: test;
      src: url(mpepc5unpb.woff);
    }

    div {
      font-family: test;
      font-size: 80px;
      text-align: center;
      margin: 200px 0;
    }
  </style>
</head>
<body>
  <div>
  0123456789
  </div>
</body>
</html>
```

![](http://asset.cjting.cn/Fvk8_hOHE5ac4YpWHy_j7idottWG.png)

åœ¨è¿™ä¸ªå­—ä½“ä¸­ï¼Œå­—ç¬¦ `0` ä¼šæ¸²æŸ“å›¾å½¢ `0`ï¼Œå­—ç¬¦ `1` ä¼šæ¸²æŸ“å›¾å½¢ `7`ï¼Œä»¥æ­¤ç±»æ¨ï¼Œå› æ­¤ï¼ŒHTML ä¸­çš„å­—ç¬¦ `96809` æ¸²æŸ“çš„å›¾å½¢å°±æ˜¯ `59605`ã€‚

è¿™ä¸ªåŸç†ä¸éš¾ç†è§£ï¼Œæˆ‘ä»¬ç”šè‡³ä¸éœ€è¦çŸ¥é“å­—ä½“æ–‡ä»¶å†…éƒ¨çš„å…·ä½“æ ¼å¼ã€‚å› ä¸ºä¸ç®¡æ€æ ·ï¼Œå­—ä½“å†…éƒ¨ä¸€å®šæœ‰ä¸€ä¸ªæ˜ å°„å…³ç³»ã€‚è¿™ä¸ªå…³ç³»è§„å®šäº†ä»€ä¹ˆæ ·çš„å­—ç¬¦æ¸²æŸ“ä»€ä¹ˆæ ·çš„å›¾å½¢ã€‚

æ­£å¸¸æƒ…å†µä¸‹ï¼Œå­—ç¬¦ 1 å¯¹åº”çš„å›¾å½¢æ˜¯ 1 çš„å½¢çŠ¶ï¼Œä½†æ˜¯é€šè¿‡ä¿®æ”¹å­—ä½“ï¼Œæˆ‘ä»¬å°±å¯ä»¥è®©å­—ç¬¦ 1 å¯¹åº”çš„å›¾å½¢æ˜¯ 9 çš„å½¢çŠ¶ï¼Œæˆ–è€…è¯´ï¼Œå…¶ä»–ä»»æ„å½¢çŠ¶ã€‚

è¿™æ ·ä»¥æ¥ï¼ŒHTML ä¸­çš„å­—ç¬¦å°±å®Œå…¨å¤±å»äº†æ„ä¹‰ï¼Œè¿™ä¸ªå­—ç¬¦æ‰€ä»£è¡¨çš„çš„å«ä¹‰è¦ä¾æ®å­—ä½“æ¥å®šã€‚

ä¸Šé¢è¿™ä¸ªå­—ä½“å®é™…ä¸Šå®šä¹‰äº†ä¸€ä¸ª `0123456789` åˆ° `0741389265` çš„æ˜ å°„ï¼Œæ‹¿åˆ° HTML ä¸­çš„å­—ç¬¦æˆ‘ä»¬éœ€è¦æ ¹æ®è¿™ä¸ªæ˜ å°„æ‰èƒ½å¾—åˆ°çœŸæ­£çš„å€¼ã€‚

åˆ·æ–°æ–—é±¼ä½ ä¼šå‘ç°ï¼Œå­—ä½“åˆå˜äº†ï¼Œæ‰€ä»¥å®ƒé‚£è¾¹è‚¯å®šæ˜¯æœ‰ä¸€ä¸ªå­—ä½“åº“çš„ï¼Œä½†æ˜¯è¿™ä¸ªä¸å…³é”®ï¼Œè§£å†³ä¸€ä¸ªå°±è§£å†³äº†æ‰€æœ‰ã€‚

é‚£ä¹ˆï¼Œå¦‚ä½•è§£å†³å­—ä½“åçˆ¬ä»è€Œå¾—åˆ°çœŸå®å…³æ³¨äººæ•°ï¼Ÿ

### åˆ†æ

ç°åœ¨æˆ‘ä»¬çŸ¥é“ï¼Œå¦‚æœè¦è·å–å…³æ³¨äººæ•°ï¼Œæˆ‘ä»¬å¿…é¡»è¦è·å–

- HTML ä¸­çš„åŸå§‹å€¼ï¼Œä¹Ÿå°±æ˜¯å‡å€¼
- å­—ç¬¦ä¸çœŸæ­£æ•°å­—ä¹‹é—´çš„æ˜ å°„å…³ç³»

è¿™ä¸¤ä¸ªé—®é¢˜éƒ½ä¸å¤ªå¥½è§£å†³ï¼Œæˆ‘ä»¬å…ˆè°ˆç¬¬ä¸€ä¸ªã€‚

æ–—é±¼çš„è¿™ä¸ªå…³æ³¨äººæ•°å¾ˆæ˜æ˜¾æ˜¯ JS æ¸²æŸ“çš„ï¼Œæˆ‘ä»¬æœ‰ä¸¤æ¡è·¯å¯ä»¥èµ°ï¼š

- ä½¿ç”¨ Headless Browserã€‚ä¹Ÿå°±æ˜¯ä½¿ç”¨ä¸€ä¸ªå®Œæ•´çš„æµè§ˆå™¨æ¥æ¸²æŸ“æ•´ä¸ªé¡µé¢ï¼Œç„¶åè·å– DOM ä¸­çš„å€¼ã€‚è¿™ä¸ªæ˜¯å…œåº•åŠæ³•ï¼Œæ°¸è¿œå¯è¡Œï¼Œä½†æ˜¯ç¼ºç‚¹æ˜¯æ•ˆç‡å¤ªå·®ã€‚å¤§å®¶å¯ä»¥çœ‹ä¸€ä¸‹æ‰“å¼€æ–—é±¼ç›´æ’­é—´é¡µé¢çš„é€Ÿåº¦ï¼Œæ­£å¸¸æƒ…å†µä¸‹ç­‰åˆ°å…³æ³¨äººæ•°æ˜¾ç¤ºçš„æ—¶å€™è‡³å°‘éœ€è¦ 5 ç§’é’Ÿã€‚
- æˆ‘ä»¬æ‰¾åˆ°æ•°æ®æºã€‚æ‰¾åˆ°æ–—é±¼çš„ JS æ˜¯è¯·æ±‚äº†å“ªä¸ªæ¥å£è·å–åˆ°äº†æ•°æ®ï¼Œç„¶åç›´æ¥è¯·æ±‚è¯¥æ¥å£ã€‚

ç¬¬äºŒä¸ªåŠæ³•çš„æ•ˆç‡ä¼šé«˜å¾ˆå¤šï¼Œä½†æ˜¯åŒæ—¶ä¹Ÿå›°éš¾å¾ˆå¤šã€‚å› ä¸º JS é€šè¿‡ä»€ä¹ˆæ‰‹æ®µè·å–äº†æ•°æ®å®åœ¨æ˜¯çµæ´»æ€§å¤ªé«˜äº†ï¼Œæœ‰å¤ªå¤šçš„åŠæ³•ï¼š

- å¯ä»¥è¯·æ±‚å¤šä¸ªæ¥å£ï¼Œç„¶åæ‹¼æ¥å¾—åˆ°æ•°æ®
- å¯ä»¥è¯·æ±‚æŸä¸ªæ¥å£ï¼Œè¿”å›å˜å½¢åçš„æ•°æ®ï¼Œç„¶å JS å†åå‘å¤„ç†
- ç»„åˆä¸Šé¢ä¸¤ç§æ–¹å¼
- ...

é¢å¯¹ä¸€å †å‹ç¼©åçš„ JS ä»£ç ï¼Œæˆ‘ä»¬æƒ³é€šè¿‡åˆ†æä»£ç çš„æ–¹å¼æ¥æ‰¾åˆ°æ•°æ®æºæ˜¯ä¸å¯è¡Œçš„ã€‚ä¸è¿‡æˆ‘ä»¬è¿˜æ˜¯æœ‰åˆ«çš„æ‰‹æ®µï¼Œè¿™ä¸ªåé¢å†è¯´ã€‚

è€ƒè™‘åˆ°æ€§èƒ½ä»¥åŠè®©ç”Ÿæ´»å˜çš„æ›´æœ‰ä¹è¶£ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©ç¬¬äºŒç§åŠæ³•ã€‚

{{% tip %}}
ç¬¬ä¸€ç§åŠæ³•æˆ‘é¡ºå¸¦æä¸€ä¸‹ï¼Œä½¿ç”¨ [Selenium](https://www.selenium.dev/) æˆ–è€… [Puppeteer](https://github.com/puppeteer/puppeteer) éƒ½å¯ä»¥ã€‚åŠ è½½ç½‘é¡µä»¥åï¼Œè½®è¯¢ç›´åˆ°å¯¹åº”çš„ DOM ä¸­æœ‰å€¼å³å¯ï¼Œé€šæ€ä»»ä½•ç½‘ç«™ã€‚
{{% /tip %}}

ç°åœ¨æˆ‘ä»¬æ¥çœ‹ç¬¬äºŒä¸ªé—®é¢˜ï¼Œä¹Ÿå°±æ˜¯å¦‚ä½•é€šè¿‡å­—ä½“æ¥è·å–æ˜ å°„å…³ç³»ã€‚

é€šè¿‡è§£æå­—ä½“æ–‡ä»¶å¯ä»¥åŠåˆ°å—ï¼Ÿä¸å¯ä»¥ï¼Œå­—ä½“æ–‡ä»¶ä¸­å­˜å‚¨çš„æ˜¯å­—ç¬¦å’Œå›¾å½¢çš„æ˜ å°„ï¼Œé‚£ä¹ˆå¯¹äºä¸€ä¸ªå›¾å½¢ï¼Œå®ƒæ˜¯æˆ‘ä»¬çœ¼ä¸­çš„ "0" è¿˜æ˜¯æˆ‘ä»¬çœ¼ä¸­çš„ "1" å­—ä½“æ–‡ä»¶ä¹Ÿæ²¡æ³•çŸ¥é“ï¼Œåœ¨å­—ä½“æ–‡ä»¶çœ¼ä¸­å°±æ˜¯ä¸€å †åæ ‡ã€‚

é‚£è¿˜èƒ½æ€ä¹ˆåŠå‘¢ï¼Ÿåªèƒ½æ¸²æŸ“å¥½ä»¥åæ‰¾ä¸ªäººæ¥çœ‹å—ï¼Ÿ

å¦‚æœæ—¶å…‰å€’é€€ 20 å¹´å›åˆ° 2000 å¹´ï¼Œææ€•åªèƒ½è¿™æ ·åšäº†ã€‚è™½ç„¶é‚£ä¸ªæ—¶å€™ä¹Ÿæœ‰å›¾å½¢è¯†åˆ«æŠ€æœ¯ï¼Œä½†æ˜¯ä¸åƒç°åœ¨è¿™æ ·æˆç†Ÿä¹Ÿä¸åƒç°åœ¨è¿™æ ·éšæ‰‹å¯å¾—ã€‚

ä½†æ˜¯ç°åœ¨æ˜¯ 2020 å¹´ï¼ŒOCR å›¾å½¢è¯†åˆ«æŠ€æœ¯å·²ç»éå¸¸æˆç†Ÿäº†ï¼Œæˆ‘ä»¬éšä¾¿æ‰¾ä¸ª OCR åº“åº”è¯¥å°±å¤Ÿç”¨äº†ã€‚

æ‰€ä»¥è¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆä¹Ÿæœ‰äº†ï¼Œæˆ‘ä»¬ä½¿ç”¨å­—ä½“æ¸²æŸ“å¥½å›¾å½¢ï¼Œç„¶åè°ƒç”¨ OCR è¯†åˆ«å›¾å½¢å¯¹åº”çš„æ•°å­—ä¾¿å¯ä»¥è·å–åˆ°æ˜ å°„å…³ç³»ã€‚

æŒ‰ç…§è¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬æ•´ä¸ªæµç¨‹ä¾¿æ˜¯

- å¯»æ‰¾æ•°æ®æº
- æ ¹æ®æ•°æ®æºè·å–å­—ä½“æ–‡ä»¶å’Œå‡æ•°æ®
- æ ¹æ®å­—ä½“æ–‡ä»¶æ¸²æŸ“å›¾å½¢
- ä½¿ç”¨ OCR æŠ€æœ¯è¯†åˆ«å›¾å½¢å¾—åˆ°æ˜ å°„å…³ç³»
- æ ¹æ®æ˜ å°„å…³ç³»å’Œå‡æ•°æ®å¾—åˆ°çœŸæ•°æ®

### æ•°æ®æº

ç°åœ¨æˆ‘ä»¬æ¥æ‰¾æ•°æ®æºï¼Œçœ‹çœ‹æ–—é±¼çš„ JS åˆ°åº•æ˜¯ä»å“ªé‡Œè·å–çš„å­—ä½“ä¿¡æ¯å’Œå‡æ•°æ®ã€‚

è¿™å…¶å®æ˜¯ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„è¿‡ç¨‹ï¼Œæˆ‘å»ºè®®æœ‰å…´è¶£çš„åŒå­¦å…ˆæš‚åœä¸‹æ¥ï¼ŒèŠ±ç‚¹æ—¶é—´è‡ªå·±è¯•ç€æ‰¾æ‰¾ï¼Œçœ‹èƒ½ä¸èƒ½æ‰¾åˆ°ã€‚

æˆ‘çš„ç¬¬ä¸€ä¸ªæƒ³æ³•å¾ˆç®€å•ï¼ŒJS ä¸€å®šæ˜¯é€šè¿‡æŸä¸ªæ¥å£å¾—åˆ°äº†è¿™äº›æ•°æ®ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬æŠŠæ‰€æœ‰ç½‘ç»œè¯·æ±‚å¯¼å‡ºä¸º HAR æ ¼å¼ï¼Œç„¶ååœ¨é‡Œé¢æœç´¢è¯•è¯•ã€‚

![](http://asset.cjting.cn/Fq-dtkNrMytLeymlkrYvFC4vypzV.png)

{{% tip %}}
ç‚¹å‡»ä¸Šå›¾ä¸­æ ‡è®°ä¸ºçº¢è‰²çš„æŒ‰é’®å°±å¯ä»¥å¯¼å‡ºè¯·æ±‚ä¸º HAR æ ¼å¼ï¼ŒHAR æ˜¯ä¸€ä¸ªæ–‡æœ¬æ ¼å¼ï¼Œéå¸¸æœ‰åˆ©äºæœç´¢ã€‚
{{% /tip %}}

æˆ‘è¯•äº†ç”¨å‡æ•°æ®ä¹Ÿå°±æ˜¯ `96809` å’Œå­—ä½“ ID `mpepc5unpb` æ¥æœç´¢ï¼Œéƒ½æ²¡æœ‰ä»»ä½•ç»“æœã€‚

åªèƒ½è¯´æˆ‘ä»¬çš„è¿æ°”ä¸å¤ªå¥½ï¼Œè¿™é‡Œæƒ…å†µå®åœ¨å¤ªå¤šäº†ï¼Œæœ‰å¯èƒ½è¿”å›çš„å€¼ç»è¿‡äº†ä¸€å®šçš„å¤„ç†æ¯”å¦‚ base64 æˆ–è€… rot13ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯å¤šæ¥å£è¿”å›ç„¶åå†æ‹¼æ¥ç»„è£…ã€‚æˆ‘ä»¬æ²¡åŠæ³•è¿›ä¸€æ­¥éªŒè¯ï¼Œåªèƒ½æ”¾å¼ƒè¿™æ¡è·¯ã€‚

{{% tip %}}
å…¶å®åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œä½¿ç”¨å…³é”®è¯æœç´¢ä¸€ä¸‹ HAR æ˜¯å¾ˆæœ‰æ•ˆçš„æ‰‹æ®µï¼Œå¾ˆå®¹æ˜“æ‰¾åˆ°å¯¹åº”çš„æ¥å£ã€‚
{{% /tip %}}

æ—¢ç„¶æ­¤è·¯ä¸é€šï¼Œæˆ‘ä»¬æ¢ä¸ªæ€è·¯ï¼Œè¯·æ±‚åˆ°äº†æ•°æ®ä»¥åï¼ŒJS ä»£ç ä¸€å®šä¼šè°ƒç”¨ç›¸å…³ API å»ä¿®æ”¹ DOMï¼Œèƒ½ä¸èƒ½ç›‘å¬åˆ°è¿™ä¸ªåŠ¨ä½œï¼Ÿåœ¨å®ƒä¿®æ”¹ DOM çš„æ—¶å€™æ‰“ä¸Šæ–­ç‚¹ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡è°ƒç”¨æ ˆçŸ¥é“æ˜¯å“ªæ®µ JS åœ¨åšæ­¤æ“ä½œï¼Œç„¶åé¡ºè…¾æ‘¸ç“œæ‰¾åˆ°å¯¹åº”çš„æ¥å£ã€‚

ç­”æ¡ˆæ˜¯æ˜¯å¯ä»¥çš„ï¼Œé€šè¿‡ä½¿ç”¨ `MutationObserver` æˆ‘ä»¬å¯ä»¥ç›‘å¬ä»»æ„ DOM çš„ä¿®æ”¹äº‹ä»¶ã€‚

```js
new MutationObserver((mutations, observer) => {
  const el = document.querySelector("span.Title-followNum")
  if (el != null) {
    observer.disconnect()
    new MutationObserver((mutations, observer) => {
      debugger
    }).observe(el, {childList: true, subtree: true})
  }
}).observe(document, {childList: true, subtree: true})
```

é€šè¿‡ [Tampermonkey](https://www.tampermonkey.net/) åŠ è½½ä¸Šé¢çš„ä»£ç ï¼Œåˆ·æ–°ï¼Œç­‰å¾…æ–­ç‚¹è§¦å‘ã€‚

![](http://asset.cjting.cn/FiL0ZC_TXcbRcuw8HwUUUn65oB9w.png)

ä»ä¸Šé¢çš„è°ƒç”¨æ ˆå¯ä»¥çœ‹å‡ºï¼Œæ•°æ®æ¥æºè‡ª WebSocketã€‚

å» Network é¢æ¿ä¸­çœ‹ä¸€ä¸‹ï¼Œæœç„¶æ˜¯è¿™æ ·ã€‚

![](http://asset.cjting.cn/Fq8Fro93Owx2qIK0GVvjB-KcwAMw.png)

{{% tip %}}
  ä¹‹åçˆ¬å–åƒæ–—é±¼è¿™æ ·çš„å¤æ‚ç½‘ç«™ï¼Œåº”è¯¥å…ˆæ£€æŸ¥ä¸€ä¸‹ WebSocket ä¸­çš„æ¶ˆæ¯ã€‚
{{% /tip %}}

è¿™ä¸ªæ¶ˆæ¯æ ¼å¼å¾ˆå¥½ç†è§£ï¼Œæˆ‘ä»¬å¯ä»¥çŒœåˆ° `cfdc@=63206` è¡¨ç¤ºå­—ç¬¦ä¸º 63206ï¼Œ`ci@=t3gadgbaon` è¡¨ç¤ºå­—ä½“ ID æ˜¯ t3gadgbaonï¼Œå’Œ DOM å¯¹ç…§ä¸€ä¸‹ï¼Œç¡®å®å¦‚æ­¤ã€‚

è‡³æ­¤æˆ‘ä»¬çš„æ•°æ®æºé—®é¢˜è§£å†³äº†ä¸€åŠï¼Œæˆ‘ä»¬çŸ¥é“äº†æ•°æ®æ˜¯æ¥è‡ª WebSocket å‘é€çš„å“åº”ã€‚ä½†æ˜¯ï¼Œå¦‚ä½•ç¨‹åºåŒ–å»è·å–è¿™ä¸ªå“åº”ï¼Ÿ

### åè®®

åˆ†æ WebSocket æ¶ˆæ¯ä¼šå‘ç°ï¼Œå®¢æˆ·ç«¯è¿æ¥ä»¥åä¼šå‘é€ä¸€æ¡ç™»å½•æ¶ˆæ¯ï¼Œç„¶åæœåŠ¡ç«¯ä¼šå›å¤å¤šä¸ªæ¶ˆæ¯ï¼Œå…¶ä¸­ï¼Œå°±æœ‰æˆ‘ä»¬æ„Ÿå…´è¶£çš„ `followed_count`ã€‚

å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯å¦‚ä¸‹ï¼š

![](http://asset.cjting.cn/FuQwIkMoJdPyskwe1E_jFezsbBkk.png)

è™½ç„¶æ˜¯äºŒè¿›åˆ¶æ¶ˆæ¯ï¼Œä½†æ˜¯å¯ä»¥çœ‹åˆ°æ¶ˆæ¯ä¸»ä½“éƒ½æ˜¯å¯è¯»çš„æ–‡æœ¬ï¼Œå¾ˆæ˜æ˜¾ï¼Œæ–—é±¼è¿™é‡Œæ˜¯è‡ªå·±å®ç°äº†ä¸€ä¸ªå†…éƒ¨åè®®æ ¼å¼ã€‚

å¼€å¤´ 12 ä¸ªå­—èŠ‚æš‚æ—¶ä¸æ¸…æ¥šä»€ä¹ˆå«ä¹‰ï¼Œç„¶åç´§è·Ÿç€ä¸€æ®µé”®å€¼å¯¹æ•°æ®ï¼Œä½¿ç”¨ `@=` è¿æ¥é”®å’Œå€¼ï¼Œä½¿ç”¨ `/` åˆ†å‰²ï¼Œæœ€åè·Ÿä¸Š `/\x00`ã€‚

å¤šæŸ¥çœ‹å‡ ä¸ªç›´æ’­é—´ä»¥åï¼Œå¯¹äºå¼€å¤´çš„ 12 ä¸ªå­—èŠ‚ï¼Œæˆ‘ä»¬ä¸éš¾åˆ†æå‡ºå‰å››ä¸ªå­—èŠ‚å’Œæ¶ˆæ¯é•¿åº¦æœ‰å…³ï¼Œä½¿ç”¨ Little Endianï¼Œä¸­é—´å››ä¸ªå­—èŠ‚å’Œå‰å››ä¸ªå­—èŠ‚ç›¸åŒï¼Œè€Œæœ€åå››ä¸ªå­—èŠ‚æ˜¯å›ºå®šå€¼ `0xb1020000`ã€‚

ä¸Šé¢çš„æ¶ˆæ¯é•¿åº¦æ˜¯ 287 ä¸ªå­—èŠ‚ï¼Œè€Œ `0x0000011b = 283`ï¼Œæ‰€ä»¥ï¼Œé•¿åº¦ç¼–ç çš„å€¼å®é™…ä¸Šæ˜¯æ•´ä¸ªæ¶ˆæ¯çš„é•¿åº¦å‡å» 4ã€‚

è¿™é‡Œè®¾è®¡å…¶å®æŒºå¥‡æ€ªçš„ï¼Œé•¿åº¦ä¿¡æ¯æ¯”å®é™…é•¿åº¦å°‘äº†å››ä¸ªå­—èŠ‚ï¼ŒåŒæ—¶å¼€å¤´åˆå¤šäº†å››ä¸ªå­—èŠ‚çš„å†—ä½™æ•°æ®ï¼Œæ€ä¹ˆçœ‹æ€ä¹ˆéƒ½åƒæ˜¯è®¾è®¡å¤±è¯¯ï¼Œç¬¬äºŒä¸ªå››å­—èŠ‚æ˜¯å¤šä½™çš„ã€‚

{{% tip %}}
å¯¹äºä¸€ä¸ªåè®®æ¥è¯´ï¼Œä½œä¸ºå¤–éƒ¨äººå‘˜ï¼Œæˆ‘ä»¬æ˜¯æ°¸è¿œæ— æ³•å¼„æ¸…æ¥šæœ‰äº›é—®é¢˜çš„æˆå› çš„ã€‚å¯èƒ½è¿™å››ä¸ªå­—èŠ‚æœ‰å…¶ä»–ç”¨å¤„ï¼Œå¯èƒ½å°±æ˜¯è®¾è®¡å¤±è¯¯ï¼Œä¹Ÿæœ‰å¯èƒ½ä¸€å¼€å§‹æ²¡æœ‰è¿™å››ä¸ªå­—èŠ‚ï¼Œåæ¥å› ä¸º bug ä¸å°å¿ƒåŠ ä¸Šäº†ï¼Œç„¶åä¸ºäº†åå‘å…¼å®¹ï¼Œå°±ä¸€ç›´å¸¦ä¸Šäº†ã€‚
{{% /tip %}}

ç°åœ¨æˆ‘ä»¬æ¥çœ‹å…·ä½“çš„é”®å€¼å¯¹ï¼š

```text
type@=loginreq
roomid@=7874579
dfl@=sn@AA=105@ASss@AA=1
username@=
password@=
ltkid@=
biz@=
stk@=
devid@=4d9c39a8a93746b6db53675800021501
ct@=0
pt@=2
cvr@=0
tvr@=7
apd@=
rt@=1593623035
vk@=6e9dfb63cdae310f97700a750b2fa47f
ver@=20190610
aver@=218101901
dmbt@=chrome
dmbv@=83
```

è¿™äº›å‚æ•°ä¸­ï¼Œ`type`, `roomid`, `devid` éƒ½å¾ˆå¥½ç†è§£ï¼Œ`dfl`, `ver`, `aver`, `dmbt`, `dmbv` è¿™äº›çœ‹èµ·æ¥åƒæ˜¯ä¸é‡è¦çš„ä¿¡æ¯æºå¸¦å­—æ®µã€‚

`rt` å¾ˆå®¹æ˜“å‘ç°æ˜¯ä¸€ä¸ªç§’çº§æ—¶é—´æˆ³ï¼Œç°åœ¨å”¯ä¸€å‰©ä¸‹çš„å°±æ˜¯ `vk` è¿™ä¸ªå­—æ®µã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹å­—æ®µå€¼çš„æ–¹å¼æ¥å¤§è‡´åˆ¤æ–­å­—æ®µçš„ä½œç”¨å’Œé‡è¦æ€§ã€‚

å¦‚æœæˆ‘ä»¬åŸå°ä¸åŠ¨çš„ä½¿ç”¨è¿™ä¸ªè¯·æ±‚ä½“ï¼ˆåœ¨æ£€æŸ¥å™¨ä¸­å³é”®é€‰æ‹© `Copy message... -> Copy as hex`ï¼‰è¯·æ±‚æ–—é±¼çš„ WebSocket æœåŠ¡ï¼Œä¼šå‘ç°ä¸€å¼€å§‹æ˜¯æœ‰æ­£å¸¸å“åº”çš„ï¼Œä½†æ˜¯è¿‡å‡ åˆ†é’Ÿåå°±æŠ¥é”™äº†ã€‚

```js
const WebSocket = require("ws")

const ws = new WebSocket("wss://wsproxy.douyu.com:6672/")

ws.on("open", () => {
  ws.send(Buffer.from("1b0100001b010000b102000074797065403d6c6f67696e7265712f726f6f6d6964403d373837343537392f64666c403d736e4041413d31303540415373734041413d312f757365726e616d65403d2f70617373776f7264403d2f6c746b6964403d2f62697a403d2f73746b403d2f6465766964403d34643963333961386139333734366236646235333637353830303032313530312f6374403d302f7074403d322f637672403d302f747672403d372f617064403d2f7274403d313539333632333033352f766b403d36653964666236336364616533313066393737303061373530623266613437662f766572403d32303139303631302f61766572403d3231383130313930312f646d6274403d6368726f6d652f646d6276403d38332f00", "hex"))
})

ws.on("message", payload => {
  console.log(payload.toString())
})
````

å¾ˆæ˜æ˜¾ï¼Œæ–—é±¼ä¼šæ ¡éªŒ `rt` çš„å€¼ï¼Œå¦‚æœæœåŠ¡å™¨æ—¶é—´å’Œ `rt` æ—¶é—´è¶…è¿‡ä¸€å®šé—´éš”ï¼Œé‚£ä¹ˆä¼šè¿”å›é”™è¯¯ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„è®¾è®¡ã€‚

å¦‚æœæˆ‘ä»¬ä¿®æ”¹äº†ä¸€ä¸‹ `vk`ï¼Œä¹Ÿä¼šå¾—åˆ°ä¸€ä¸ªé”™è¯¯ï¼Œè¿™è¯´æ˜ `vk` æ˜¯ç±»ä¼¼ç­¾åçš„ä¸œè¥¿ï¼Œè€Œä¸æ˜¯ä»€ä¹ˆä¿¡æ¯æºå¸¦å­—æ®µï¼ŒæœåŠ¡ç«¯ä¼šæ ¡éªŒå®ƒçš„æœ‰æ•ˆæ€§ã€‚

å¯¹äº `dfl`, `ver`, `aver`, `dmbt`, `dmbv` è¿™äº›å­—æ®µï¼Œæˆ‘ä»¬ä¼šå‘ç°éšä¾¿ä¿®æ”¹éƒ½ä¸ä¼šå½±å“ç»“æœï¼Œè¯´æ˜æˆ‘ä»¬çš„ä¹‹å‰çš„çŒœæµ‹æ˜¯æ­£ç¡®çš„ã€‚

æ‰€ä»¥ï¼Œç°åœ¨å‰©ä¸‹çš„é—®é¢˜å°±æ˜¯è¦ææ¸…æ¥š `vk` çš„ç­¾åè§„åˆ™ï¼Œè¿™ä¸ªåªèƒ½ä»æºç å…¥æ‰‹ã€‚

Chrome æ£€æŸ¥å™¨ä¸­å¯¹äºæ¯ä¸ªç½‘ç»œè¯·æ±‚éƒ½ä¼šæ˜¾ç¤ºå®ƒçš„ Initiatorï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªè¯·æ±‚æ˜¯ä»€ä¹ˆä»£ç å‘èµ·çš„ã€‚

![](http://asset.cjting.cn/FovjSlp1Srpyg5rxzb4UAbUgLnq3.png)

é¼ æ ‡æ”¾ä¸Šå»å¯ä»¥çœ‹åˆ°å®Œæ•´çš„è°ƒç”¨æ ˆã€‚

![](http://asset.cjting.cn/Fv229dbVo8CcUkUxA2mQqhbUQRv7.png)

æˆ‘ä»¬çš„æ€è·¯æ˜¯æ‰¾åˆ°å‘é€æ¶ˆæ¯çš„åœ°æ–¹ï¼Œæ‰“ä¸Šæ–­ç‚¹ï¼Œé€šè¿‡è°ƒç”¨æ ˆå¾€ä¸Šæ‰¾ã€‚

æ‰€ä»¥æ‰“å¼€æœ€ä¸Šé¢çš„ `playerSDK-room_4a27f53.js` æ–‡ä»¶ï¼Œæœç´¢å…³é”®å­— `send`ï¼Œå¾ˆå®¹æ˜“æ‰¾åˆ°ä¸‹é¢è¿™æ®µä»£ç ã€‚

![](http://asset.cjting.cn/Fp_7vBkxaKHx5DLxAY3Td1rcoZNn.png)

é€šè¿‡æ–­ç‚¹æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œç™»å½•æ¶ˆæ¯å°±æ˜¯é€šè¿‡è¿™é‡Œå‘é€çš„ï¼Œå› ä¸º `e` æ˜¯ç™»å½•çš„æ¶ˆæ¯ä½“ã€‚

å±•å¼€è°ƒç”¨æ ˆï¼Œä¼šå‘ç°æœ‰ä¸€ä¸ªå‡½æ•°å«åš `userLogin`ï¼Œç‚¹è¿›å»ã€‚

![](http://asset.cjting.cn/FuvEM10TjNMxYOCIioM_Bjsc7wLe.png)

å¯ä»¥å‘ç°æˆ‘ä»¬æ¥åˆ°äº† `common-pre~9fd51f5d.js` æ–‡ä»¶ï¼Œå¯ä»¥çŒœåˆ° `h.default.jsEncrypt.async()` è¿™æ®µä»£ç åº”è¯¥å°±æ˜¯ç­¾åç›¸å…³çš„ä»£ç ã€‚

æˆ‘ä»¬å¯ä»¥æ–­ç‚¹è¿›è¿™ä¸ªå‡½æ•°ï¼Œç„¶åç»§ç»­æ‰¾ã€‚æˆ–è€…ï¼Œæˆ‘ä»¬ç›´æ¥æœç´¢ `vk`ã€‚

![](http://asset.cjting.cn/FgPsfPNSU-t8PhBHlQpRiDpCqUVF.png)

ç„¶åæˆ‘ä»¬å°±å‘ç° `vk` çš„å€¼ç­‰äº `L(y + "r5*^5;}2#${XF[h+;'./.Q'1;,-]f'p[" + p)`ã€‚åˆ°è¿™é‡Œå°±ç®€å•äº†ï¼Œé€šè¿‡æ–­ç‚¹å¯ä»¥å‘ç° `y` å°±æ˜¯ `rt`ï¼Œ`p` æ˜¯ `devid`ï¼Œè€Œ `L` æ˜¯ä¸€ä¸ªæ±‚ md5 å€¼çš„å‡½æ•°ã€‚

æ‰€ä»¥ `vk` çš„ç­¾åç®—æ³•æ˜¯ `vk = md5(rt + "r5*^5;}2#${XF[h+;'./.Q'1;,-]f'p[" + devid)`

ç°åœ¨æ•´ä¸ªæ¶ˆæ¯ä½“çš„ç»“æ„æˆ‘ä»¬éƒ½æ¸…æ¥šäº†ï¼Œæˆ‘ä»¬è¯•ç€æ„é€ æ¶ˆæ¯ä½“è¯·æ±‚æ–—é±¼æœåŠ¡å™¨çœ‹çœ‹èƒ½ä¸èƒ½å¾—åˆ°å“åº”ã€‚

```js
const encode = obj => Object.keys(obj).map(k => `${ k }@=${ obj[k] }`).join("/")

const decode = str => {
  return str.split("/").reduce((acc, pair) => {
    const [key, value] = pair.split("@=")
    acc[key] = value
    return acc
  }, {})
}

const crypto = require("crypto")
const md5Hash = crypto.createHash("md5")
const md5 = payload => {
  return md5Hash.update(payload).digest("hex")
}

// 4-byte length, 4-byte length, 0xb102, 0x0000
const getPayload = obj => {
  const arr = [0, 0, 0, 0, 0, 0, 0, 0, 0xb1, 0x02, 0x00, 0x00]

  const objEncoded = encode(obj) + "/\x00"
  arr.push(...objEncoded.split("").map(c => c.charCodeAt(0)))

  const payload = Buffer.from(arr)
  const dv = new DataView(payload.buffer, payload.byteOffset)
  const length = payload.length - 4
  dv.setUint32(0, length, true)
  dv.setUint32(4, length, true)

  return payload
}

ws.on("open", () => {
  // è¿™ä¸ªéšä¾¿å¡«å†™ä¸€ä¸ª
  const devID = "4d9c39a8a93746b6db53675800021501"

  const rt = (new Date().getTime() / 1000) >> 0

  const obj = {
    type: "loginreq",
    roomid: roomID,
    devid: devID,
    rt: rt,
    vk: md5(rt + "r5*^5;}2#${XF[h+;'./.Q'1;,-]f'p[" + devID),
  }

  const payload = getPayload(obj)
  ws.send(payload)
})

ws.on("message", payload => {
  const data = decode(payload.slice(12).toString())
  if(data.type === "followed_count") {
    console.log(data)
  } else {
    console.log(data.type)
  }
})
```

æˆåŠŸäº†ï¼

![](http://asset.cjting.cn/Ful4n8KK-B5sBNFK9i8eEX3oUIIu.png)

### OCR

è·å–åˆ°å­—ä½“ ID å’Œå‡æ•°æ®ä»¥åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¦åšçš„å°±æ˜¯ä½¿ç”¨å­—ä½“æ¸²æŸ“ä¸€å¼ å›¾ç‰‡ï¼Œç„¶åè°ƒç”¨ OCR å·¥å…·è¯†åˆ«å›¾ç‰‡ã€‚

æˆ‘ä»¬å…ˆä½¿ç”¨å­—ä½“ ID å°†å­—ä½“ä¸‹è½½ä¸‹æ¥ï¼Œå­—ä½“çš„ä¸‹è½½ URL æ˜¯å›ºå®šçš„ `https://shark.douyucdn.cn/app/douyu/res/font/FONT_ID.woff`ã€‚

æ€æ ·æ¸²æŸ“å­—ä½“åˆ°å›¾ç‰‡å‘¢ï¼Ÿè¿™ä¸ªé—®é¢˜æ–¹æ¡ˆæœ‰å¾ˆå¤šï¼Œä¸Šæ–‡ä¸­æˆ‘ä»¬åˆ©ç”¨äº†æµè§ˆå™¨ï¼Œè¿™é‡Œæˆ‘é€‰æ‹©ä½¿ç”¨ SDLã€‚

```c
#include <stdio.h>
#include <SDL2/SDL.h>
#include <SDL2/SDL_ttf.h>
#include <SDL2/SDL_image.h>

int
main(void)
{
  if(TTF_Init() == -1) {
    printf("error: %s\n", TTF_GetError());
    return 1;
  }

  TTF_Font *font = TTF_OpenFont("test.woff", 50);
  if(font == NULL) {
    printf("error: %s\n", TTF_GetError());
    return 1;
  }

  SDL_Color black = { 0x00, 0x00, 0x00 };
  SDL_Surface *surface = TTF_RenderText_Solid(font, "0123456789", black);
  if(surface == NULL) {
    printf("error: %s\n", TTF_GetError());
    return 1;
  }

  IMG_SavePNG(surface, "test.png");
  return 0;
}
```

SDL æ¸²æŸ“é€Ÿåº¦éå¸¸å¿«ï¼Œç»“æœä¹Ÿå¾ˆæ¸…æ¥šï¼Œç”¨æ¥ OCR åº”è¯¥è¶³å¤Ÿäº†ã€‚

![](http://asset.cjting.cn/FpSLekVg2B25ags6kwehiDgAgZ0r.png)

å›¾å½¢è¯†åˆ«è¿™ä¸€å—æˆ‘å¹¶æ²¡æœ‰ä»€ä¹ˆå¤ªå¤šç»éªŒï¼Œä½†æ˜¯æ²¡å…³ç³»ï¼Œæ„Ÿè°¢å¼€æºä¸–ç•Œã€‚æˆ‘ä»¬ Google OCRï¼Œå¾ˆå®¹æ˜“å°±ä¼šæ‰¾åˆ°ä¸€ä¸ªçœ‹èµ·æ¥å¾ˆå‰å®³çš„åº“ [tesseract](https://github.com/tesseract-ocr/tesseract)ã€‚

å…ˆå®‰è£…å®ƒ `brew install tesseract`ã€‚

é¡¹ç›®æœ¬èº«æ˜¯ C++ çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨ C++ è°ƒç”¨ã€‚ä½†æ˜¯å› ä¸ºåé¢æˆ‘æ‰“ç®—ä½¿ç”¨ Go å†™ä¸€ä¸ªå®Œæ•´çš„å…³æ³¨äººæ•°çˆ¬è™«ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ Go æ¥è°ƒç”¨ã€‚

å®‰è£… Go çš„ç»‘å®š [gosseract](https://github.com/otiai10/gosseract)ï¼Œç„¶åä½¿ç”¨å¦‚ä¸‹ä»£ç æ¥è¯•è¯•ï¼š

```go
package main

import (
  "fmt"

  "github.com/otiai10/gosseract/v2"
)

func main() {
  client := gosseract.NewClient()
  defer client.Close()

  client.SetImage("test.png")
  client.SetWhitelist("0123456789")
  text, _ := client.Text()
  fmt.Println(text)
}
```

ç„¶åæˆ‘ä»¬å¾ˆé¡ºåˆ©åœ°å°±å¾—åˆ°äº†ç»“æœï¼Œå¼€æºä¸‡å²ï¼ğŸ‰

![](http://asset.cjting.cn/Fp-epduQcenYERhgqPyFAhesEOJl.png)

### æœ€ç»ˆå®ç°

æœ€åï¼Œæˆ‘ä»¬æŠŠä¸Šé¢çš„å„ä¸ªæ­¥éª¤æ•´åˆä¸€ä¸‹ï¼Œä½¿ç”¨ Go æ¥å®ç°ä¸€ä¸ªå®Œæ•´çš„æ–—é±¼å…³æ³¨äººæ•°çˆ¬è™«ï¼Œæœ€ç»ˆçš„ä»£ç åœ¨è¿™é‡Œ [douyu-crawler-demo](https://github.com/cj1128/douyu-crawler-demo)ã€‚

ä»£ç çš„å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š

- å¯åŠ¨ä¸€å®šæ•°é‡çš„ worker
- é€šè¿‡ channel å‘é€ roomID ç»™åˆ° worker
- worker çˆ¬å–å…³æ³¨äººæ•°
  + é¦–å…ˆé€šè¿‡ WebSocket è·å–å­—ä½“ä¿¡æ¯å’Œå‡æ•°æ®
  + ä¸‹è½½å­—ä½“åˆ°ç¼“å­˜ç›®å½•ä¸­
  + è°ƒç”¨ SDL æ¸²æŸ“å­—ä½“ä¸ºå›¾ç‰‡åˆ°ç¼“å­˜ç›®å½•ä¸­
  + ä½¿ç”¨ OCR è¯†åˆ«å›¾ç‰‡å¾—åˆ°æ˜ å°„å…³ç³»
  + å­˜å‚¨æ˜ å°„å…³ç³»ï¼ˆç”Ÿäº§è‚¯å®šæ˜¯å†™å…¥æ•°æ®åº“ï¼Œè¿™é‡Œæ˜¯ demoï¼Œæˆ‘ä»¬ä½¿ç”¨æ–‡ä»¶ï¼‰
  + è¾“å‡ºç»“æœï¼ˆåŒæ ·ï¼Œç”Ÿäº§æ˜¯å†™å…¥æ•°æ®åº“ï¼Œè¿™é‡Œæˆ‘ä»¬å†™å…¥åˆ°ç»“æœæ–‡ä»¶ï¼‰

å½“ç„¶ï¼Œå¦‚æœè¦åšä¸€ä¸ªç”Ÿäº§çº§åˆ«çš„çˆ¬è™«ï¼Œè¿˜æœ‰å¾ˆå¤šé—®é¢˜è¦å¤„ç†ï¼š

- æ—¥å¿—ï¼šè¯¦ç»†çš„æ—¥å¿—å¯ä»¥å¸®åŠ©åˆ†æé—®é¢˜ï¼Œæ”¹è¿›ä¸è¶³ä»¥åŠæ¢å¤æ•°æ®ç­‰ã€‚
- é”™è¯¯å¤„ç†ï¼šçˆ¬è™«çš„å¤©ç„¶å±æ€§å°±æ˜¯éšæ—¶å¯èƒ½æ— æ³•å·¥ä½œï¼Œå®Œå–„çš„é”™è¯¯å¤„ç†å’ŒæŠ¥è­¦æœºåˆ¶æ˜¯å¿…é¡»çš„ã€‚
- é‡è¯•æœºåˆ¶ï¼šå¾ˆå¤šæ¥å£ä¼šæŠ¥é”™ï¼Œéœ€è¦æœ‰ä¸€å®šçš„é‡è¯•æœºåˆ¶ã€‚
- æ•°æ®æ ¡éªŒï¼šæ¯ä¸€æ­¥è·å–åˆ°çš„æ•°æ®éƒ½éœ€è¦æ ¡éªŒæœ‰æ•ˆæ€§ï¼Œå¦åˆ™å¾ˆå®¹æ˜“åœ¨æ•°æ®åº“ä¸­å†™å…¥æ— æ•ˆæ•°æ®ã€‚
- äººå·¥å¹²é¢„ï¼šæœ‰äº›ç¯èŠ‚æ¯”å¦‚ OCR çš„å‡†ç¡®ç‡æ˜¯æ— æ³•åšåˆ° 100% çš„ï¼Œè¦è€ƒè™‘åˆ°å¤±è´¥çš„æƒ…å†µï¼Œä¸€æ—¦ OCR è¯†åˆ«å¤±è´¥ï¼Œéœ€è¦å¼•å…¥äººå·¥å¹²é¢„æµç¨‹ã€‚
- IP æ± ï¼šå¾ˆå¤šæ¥å£ä¼šé™åˆ¶ IP çš„è®¿é—®é¢‘ç‡ï¼Œè¿™ä¸ªæ—¶å€™è¦æŒ‚ IP æ± ã€‚

æœ€åï¼Œæˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹æˆ‘ä»¬çš„ç¨‹åºæ•ˆæœã€‚[roomids.txt](https://github.com/cj1128/douyu-crawler-demo/blob/master/roomids.txt) ä¸­å«æœ‰ 120 ä¸ªæ–—é±¼ä¸»æ’­çš„ roomIDï¼Œæˆ‘ä»¬ä½¿ç”¨çˆ¬è™«æ¥çˆ¬å–è¿™ 120 ä¸ªä¸»æ’­çš„å…³æ³¨äººæ•°ã€‚

```bash
$ douyu-crawler-demo -f roomids.txt
....
2020/07/02 13:28:41 all done in 36.313598957s
2020/07/02 13:28:41   total: 120
2020/07/02 13:28:41   success: 86
2020/07/02 13:28:41   error: 34
2020/07/02 13:28:41   ocr failed: 0
```

120 ä¸ªä¸»æ’­ï¼Œä¸€å…±èŠ±è´¹äº† 36sï¼Œè¿™ä¸ªé€Ÿåº¦è¿˜æ˜¯éå¸¸ç†æƒ³çš„ï¼Œä½¿ç”¨ Headless Browser æ˜¯ä¸å¯èƒ½æœ‰è¿™ä¸ªé€Ÿåº¦çš„ã€‚

ä½†æ˜¯æˆ‘ä»¬ä¼šå‘ç°ï¼Œå…¶ä¸­æœ‰ä¸€äº›å¤±è´¥äº†ï¼Œçœ‹æ—¥å¿—ä¸»è¦æ˜¯ WebSocket æ²¡æœ‰è¿”å›å€¼æˆ–è€…è¶…æ—¶äº†ï¼Œè¿™åœ¨çˆ¬è™«ä¸­å¾ˆæ­£å¸¸ï¼Œç›´æ¥é‡è¯•ä¸€ä¸‹å°±è¡Œäº†ã€‚

```bash
$ douyu-crawler-demo -f roomids.txt
...
2020/07/02 13:29:42 all done in 23.660793712s
2020/07/02 13:29:42   total: 120
2020/07/02 13:29:42   success: 120
2020/07/02 13:29:42   error: 0
2020/07/02 13:29:42   ocr failed: 0
```

è¿™æ¬¡å…¨éƒ¨æˆåŠŸäº†ï¼Œç»“æœæ–‡ä»¶åœ¨ `result/result.txt` ä¸­ã€‚

{{% tip %}}
å¯ä»¥å‘ç° OCR æ²¡æœ‰ä¸€æ¬¡å¤±è´¥ï¼Œtesseract å¤ªèµäº†ğŸ‘
{{% /tip %}}

```bash
$ head result/result.txt
5324388,b72iyfidmi,5538567,1169154
582074,yzs37nb5ik,447330,116880
6937618,21lwetbnlg,579241,128374
5632185,flecd9ycbg,495291,327621
6794440,21lwetbnlg,80850,90910
52319,tcmpj93mbl,452436,576593
820795,n1kril0e2r,80063,40025
5168755,5n5pkb33y,861526,689528
8546776,84c209m14f,9869,3783
5747228,svk3del36j,319692,127978
```

æ¯ä¸ªå­—æ®µåˆ†åˆ«æ˜¯æˆ¿é—´å·ã€å­—ä½“ IDã€å‡æ•°æ®ä»¥åŠçœŸæ•°æ®ã€‚

## é˜²å®ˆ

è®²å®Œäº†è¿›æ”»ï¼Œç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚æœæˆ‘ä»¬ç«™åœ¨é˜²å®ˆæ–¹ï¼Œéœ€è¦ä½¿ç”¨è¿™ç§æŠ€å·§æ¥åçˆ¬ï¼Œè¯¥æ€ä¹ˆåšï¼Ÿ

å­—ä½“åçˆ¬çš„æ ¸å¿ƒæ˜¯éšæœºç”Ÿæˆä¸€ä¸ªæ˜ å°„ï¼Œæ ¹æ®æ˜ å°„ç”Ÿæˆå­—ä½“ï¼Œç„¶åè¿”å›å­—ä½“å’Œå‡æ•°æ®ç»™åˆ°å‰ç«¯ã€‚

è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±éœ€è¦äº†è§£ä¸€ä¸‹å­—ä½“çš„æ–‡ä»¶æ ¼å¼äº†ã€‚å¸¸è§çš„å­—ä½“æ ¼å¼æœ‰ `ttf`, `otf`, `woff`ã€‚å…¶ä¸­ `woff` æ˜¯ä¸€ä¸ªåŒ…è£…æ ¼å¼ï¼Œé‡Œé¢çš„å­—ä½“ä¸æ˜¯ `ttf` å°±æ˜¯ `otf` çš„ï¼Œæ‰€ä»¥çœŸæ­£çš„å­˜å‚¨æ ¼å¼åªæœ‰ä¸¤ç§ï¼Œ`ttf` å’Œ `otf`ã€‚

è¿™ä¸¤ç§æ ¼å¼å¾ˆæ˜æ˜¾éƒ½æ˜¯äºŒè¿›åˆ¶æ ¼å¼ï¼Œæ²¡æ³•ç›´æ¥æ‰“å¼€çœ‹ã€‚ä½†æ˜¯ï¼Œå¹¸è¿çš„æ˜¯ï¼Œå­—ä½“æœ‰ä¸€ä¸ªæ ¼å¼å«åš `ttx`ï¼Œæ˜¯ä¸€ä¸ª XML çš„å¯è¯»æ ¼å¼ã€‚

æˆ‘ä»¬çš„åŸºæœ¬æ€è·¯æ˜¯ï¼š

- è£å‰ªå­—ä½“ï¼šæ ¹æ®ä¸€ä¸ªåŸºç¡€å­—ä½“è£å‰ªæ‰æˆ‘ä»¬ä¸éœ€è¦çš„å­—ç¬¦ï¼Œæ¯”å¦‚æ–—é±¼è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬åªéœ€è¦æ•°å­—å³å¯
- å°†å­—ä½“è½¬æ¢æˆ `ttx` æ ¼å¼æ‰“å¼€
- æ‰¾åˆ°å­—ç¬¦å’Œå›¾å½¢çš„æ˜ å°„
- ä¿®æ”¹è¿™ä¸ªæ˜ å°„
- å†å¯¼å‡ºå­—ä½“ä¸º `ttf`

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ [fonttools](https://github.com/fonttools/fonttools) è¿™ä¸ªå¼ºå¤§çš„ Python åº“æ¥è¿›è¡Œåç»­çš„æ“ä½œã€‚

æˆ‘ä»¬ä»¥å¼€æºå­—ä½“ [Hack](https://sourcefoundry.org/hack/) ä¸ºä¾‹ã€‚

æˆ‘ä»¬å…ˆæ¥è£å‰ªå­—ä½“ã€‚å®‰è£…å¥½ `fonttools` ä»¥åä¼šé»˜è®¤å®‰è£…å‡ ä¸ªå·¥å…·ï¼Œå…¶ä¸­ä¹‹ä¸€æ˜¯ [pyftsubset](https://fonttools.readthedocs.io/en/latest/subset/index.html?highlight=pyftsubset)ï¼Œè¿™ä¸ªå·¥å…·å°±å¯ä»¥ç”¨æ¥è£å‰ªå­—ä½“ã€‚

```bash
$ pyftsubset hack.ttf --text="0123456789"
WARNING: TTFA NOT subset; don't know how to subset; dropped
```

ä¸Šé¢çš„ warning ä¸ç”¨ä»‹æ„ï¼Œè¿è¡Œå®Œæ¯•ä¹‹åæˆ‘ä»¬å¾—åˆ°äº† `hack.subset.ttf`ï¼Œè¿™ä¸ªä¾¿æ˜¯è£å‰ªåçš„å­—ä½“ï¼Œåªæ”¯æŒæ¸²æŸ“ 0 ~ 9ã€‚

æ¥ä¸‹æ¥è½¬æ¢å­—ä½“ä¸ºå¯è¯»çš„ ttx æ ¼å¼ã€‚åŒæ ·ï¼Œfonttools è‡ªå¸¦äº†ä¸€ä¸ªå·¥å…·å«åš `ttx`ï¼Œç›´æ¥ä½¿ç”¨å³å¯ã€‚

```bash
$ ttx hack.subset.ttf
Dumping "hack.subset.ttf" to "hack.subset.ttx"...
Dumping 'GlyphOrder' table...
Dumping 'head' table...
Dumping 'hhea' table...
Dumping 'maxp' table...
Dumping 'OS/2' table...
Dumping 'hmtx' table...
Dumping 'cmap' table...
Dumping 'fpgm' table...
Dumping 'prep' table...
Dumping 'cvt ' table...
Dumping 'loca' table...
Dumping 'glyf' table...
Dumping 'name' table...
Dumping 'post' table...
Dumping 'gasp' table...
Dumping 'GSUB' table...
```

æˆ‘ä»¬ä¼šå‘ç°ç›®å½•ä¸‹å¤šäº†ä¸€ä¸ª `hack.subset.ttx` æ–‡ä»¶ï¼Œæ‰“å¼€è§‚å¯Ÿä¸€ä¸‹ã€‚

å¾ˆå®¹æ˜“å°±å¯ä»¥å‘ç°ï¼Œ`cmap` æ ‡ç­¾ä¸­å®šä¹‰äº†å­—ç¬¦å’Œå›¾å½¢çš„æ˜ å°„ã€‚

```xml
<cmap>
  <tableVersion version="0"/>
  <cmap_format_4 platformID="0" platEncID="3" language="0">
    <map code="0x30" name="zero"/><!-- DIGIT ZERO -->
    <map code="0x31" name="one"/><!-- DIGIT ONE -->
    <map code="0x32" name="two"/><!-- DIGIT TWO -->
    <map code="0x33" name="three"/><!-- DIGIT THREE -->
    <map code="0x34" name="four"/><!-- DIGIT FOUR -->
    <map code="0x35" name="five"/><!-- DIGIT FIVE -->
    <map code="0x36" name="six"/><!-- DIGIT SIX -->
    <map code="0x37" name="seven"/><!-- DIGIT SEVEN -->
    <map code="0x38" name="eight"/><!-- DIGIT EIGHT -->
    <map code="0x39" name="nine"/><!-- DIGIT NINE -->
  </cmap_format_4>
  ...
</cmap>
```

`0x30` ä¹Ÿå°±æ˜¯å­—ç¬¦ 0 å¯¹åº” `name="zero"` çš„ `TTGlyph`ï¼ŒTTGlyph ä¸­å®šä¹‰äº†æ¸²æŸ“è¦ç”¨çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ä¸€äº›åæ ‡ã€‚

```xml
<TTGlyph name="zero" xMin="123" yMin="-29" xMax="1110" yMax="1520">
  <contour>
    <pt x="617" y="-29" on="1"/>
    <pt x="369" y="-29" on="0"/>
    <pt x="246" y="165" on="1"/>
    <pt x="123" y="358" on="0"/>
    <pt x="123" y="745" on="1"/>
    <pt x="123" y="1134" on="0"/>
    <pt x="246" y="1327" on="1"/>
    <pt x="369" y="1520" on="0"/>
    <pt x="616" y="1520" on="1"/>
    <pt x="864" y="1520" on="0"/>
    <pt x="987" y="1327" on="1"/>
    <pt x="1110" y="1134" on="0"/>
    <pt x="1110" y="745" on="1"/>
    <pt x="1110" y="-29" on="0"/>
  </contour>
  ...
</TTGlyph>
```

é‚£ä¹ˆæ€ä¹ˆåˆ¶ä½œæ··æ·†å­—ä½“çš„æ–¹æ³•å°±ä¸è¨€è€Œå–»äº†ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹è¿™ä¸ª XMLï¼ŒæŠŠ `TTGlyph(name="zero")` æ ‡ç­¾çš„ `zero` æ¢æˆ `eight` ç„¶åæŠŠ `TTGlyph(name="eight")` æ ‡ç­¾çš„ `eight` æ¢æˆ `zero`ï¼Œä¿å­˜æ–‡ä»¶ä¸º `fake.ttx`ã€‚

å¯¼å‡º ttx åˆ° ttf ä¾ç„¶æ˜¯ä½¿ç”¨ `ttx` å·¥å…·ã€‚

```
$ ttx -o fake.ttf fake.ttx
Compiling "fake.ttx" to "fake.ttf"...
Parsing 'GlyphOrder' table...
Parsing 'head' table...
Parsing 'hhea' table...
Parsing 'maxp' table...
Parsing 'OS/2' table...
Parsing 'hmtx' table...
Parsing 'cmap' table...
Parsing 'fpgm' table...
Parsing 'prep' table...
Parsing 'cvt ' table...
Parsing 'loca' table...
Parsing 'glyf' table...
Parsing 'name' table...
Parsing 'post' table...
Parsing 'gasp' table...
Parsing 'GSUB' table...
```

ä½¿ç”¨ä¸Šæ–‡æåˆ°çš„ HTML ä½¿ç”¨ `fake.ttf` æ¸²æŸ“ 0 ~ 9ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æˆåŠŸåœ°åˆ¶ä½œäº†ä¸€ä¸ªæ··æ·†å­—ä½“ã€‚

![](http://asset.cjting.cn/FsXY7liRLS9B1_55DC3HQCY0Va7a.png)

[genfont.py](https://github.com/cj1128/douyu-crawler-demo/blob/master/genfont.py) æ˜¯æˆ‘ä½¿ç”¨ Python ç¼–å†™çš„è„šæœ¬ï¼Œå¯ä»¥è‡ªåŠ¨ç”Ÿæˆä»»æ„æ•°é‡çš„æ··æ·†å­—ä½“ã€‚

```bash
# ä½¿ç”¨ hack.subset.ttf ä¸ºåŸºç¡€ç”Ÿæˆ 20 ä¸ªæ··æ·†å­—ä½“
$ ./genfont.py hack.subset.ttf 20
....
$ ls result/generated # ç»“æœå­˜å‚¨åœ¨è¿™ä¸ªç›®å½•ä¸­
0018fb8365.7149586203.ttf  267ccb0e95.8402759136.ttf
08a9457ab9.3958406712.ttf  281ef45f09.2154786390.ttf
1bbdd405ca.9147328650.ttf  788e0c7651.8790526413.ttf
1f985cd725.6417320895.ttf  5433d36fde.1326570894.ttf
2d56def315.8962135047.ttf  6844549191.3597082416.ttf
6bd27a4bac.0658392147.ttf  a422833064.8416930752.ttf
6e337094a4.0754261839.ttf  c7f0591c38.5761804329.ttf
9a0e22d6ad.9173452860.ttf  d3269bd2ce.0384976152.ttf
9a407f17c1.8379426105.ttf  f97691cc25.1587964230.ttf
44a428c37d.3602974581.ttf  ffe2c54286.6894312057.ttf
```

æ–‡ä»¶åçš„å½¢å¼ä¸º `fontID.mapping.ttf`ã€‚æ¯”å¦‚ `0018fb8365.7149586203.ttf` è¿™ä¸ªå­—ä½“ä¼šå°† `0` æ¸²æŸ“ä¸º `7`ã€‚
