---
title: æœ€å°çš„ 64 ä½ Hello World
tags: [linux, elf, assembly]
cover: http://asset.cjting.cn/FnMniJy5zFNdS5hK8UcXxwcvnoKC.jpg
date: 2020-11-30T21:31:08+08:00
---

Hello World åº”è¯¥æ˜¯æ¯ä¸€ä¸ªç¨‹åºå‘˜çš„å¯è’™ç¨‹åºï¼Œå‡ºè‡ªäº [Brian Kernighan](https://en.wikipedia.org/wiki/Brian_Kernighan) å’Œ [Dennis Ritchie](https://en.wikipedia.org/wiki/Dennis_Ritchie) çš„ä¸€ä»£ç»å…¸è‘—ä½œ [The C Programming Language](https://en.wikipedia.org/wiki/The_C_Programming_Language)ã€‚

```c
// hello.c
#include <stdio.h>

int main() {
  printf("hello, world\n");
  return 0;
}
```

è¿™æ®µä»£ç æˆ‘æƒ³å¤§å®¶éƒ½å¤ªç†Ÿæ‚‰äº†ï¼Œä½†æ˜¯å¦‚æœç»†ç©¶èµ·æ¥ï¼Œé‡Œé¢éšè—ç€å¾ˆå¤šé—®é¢˜ï¼š

- `#include <stdio.h>` å’Œ `#include "stdio.h"` æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
- `stdio.h` æ–‡ä»¶åœ¨å“ªé‡Œï¼Ÿé‡Œé¢æ˜¯ä»€ä¹ˆå†…å®¹ï¼Ÿ
- ä¸ºä»€ä¹ˆå…¥å£æ˜¯ `main` å‡½æ•°ï¼Ÿå¯ä»¥å†™ä¸€ä¸ªç¨‹åºå…¥å£ä¸æ˜¯ `main` å—ï¼Ÿ
- `main` çš„è¿”å›å€¼æœ‰ä»€ä¹ˆç”¨ï¼Ÿæ˜¯è°åœ¨å¤„ç† `main` çš„è¿”å›å€¼ï¼Ÿ
- `printf` æ˜¯è°å®ç°çš„ï¼Ÿå¦‚æœä¸ç”¨ `printf` å¯ä»¥åšåˆ°åœ¨ç»ˆç«¯ä¸­æ‰“å°å­—ç¬¦å—ï¼Ÿ

<!--more-->

ä¸Šé¢è¿™äº›é—®é¢˜éƒ½å¾ˆæœ‰æ„æ€ï¼Œæ¶‰åŠåˆ°ç¨‹åºçš„ç¼–è¯‘ã€é“¾æ¥å’Œè£…è½½ã€‚ç°ä»£çš„ IDE åœ¨æ–¹ä¾¿æˆ‘ä»¬å¼€å‘çš„åŒæ—¶ï¼Œä¹Ÿå°†å¾ˆå¤šåº•å±‚çš„ç»†èŠ‚éšè—äº†èµ·æ¥ã€‚å¾€å¾€å†™å®Œä»£ç ä»¥åï¼Œç‚¹å‡»ã€Œæ„å»ºã€å°±è¡Œäº†ï¼Œè‡³äºæ„å»ºåœ¨å‘ç”Ÿä»€ä¹ˆï¼Œå…·ä½“æ˜¯æ€ä¹ˆæ„å»ºçš„ï¼Œå¾ˆå¤šäººå¯èƒ½å¹¶ä¸å…³å¿ƒï¼Œç”šè‡³æ ¹æœ¬ä¸çŸ¥é“ä»æºä»£ç åˆ°å¯æ‰§è¡Œç¨‹åºè¿™ä¸­é—´ç»å†äº†ä»€ä¹ˆã€‚

ç¼–è¯‘ã€é“¾æ¥å’Œè£…è½½æ˜¯ä¸€ä¸ªéå¸¸å·¨å¤§çš„è¯é¢˜ï¼Œä¸æ˜¯ä¸€ç¯‡åšå®¢å¯ä»¥æ¶µç›–çš„ã€‚åœ¨è¿™ç¯‡åšå®¢ä¸­ï¼Œæˆ‘æƒ³ä½¿ç”¨ã€Œæ–‡ä»¶å°ºå¯¸ã€ä½œä¸ºçº¿ç´¢ï¼Œæ¥ä»‹ç»ä» C æºä»£ç åˆ°å¯æ‰§è¡Œç¨‹åºè¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ‰€ç»å†çš„æ­¥éª¤å’Œæ¶‰åŠçš„çŸ¥è¯†ç‚¹ã€‚

å¯¹äºæ¯ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œæˆ‘ä¼šç»™å‡ºè¯¦ç»†ä»‹ç»å®ƒçš„é“¾æ¥ã€‚æ‰€ä»¥ï¼Œè¿™ç¯‡åšå®¢æ›´åƒæ˜¯ä¸€ä¸ªè·¯çº¿å›¾ï¼Œæ ‡è®°äº†å‰è¿›é“è·¯ä¸Šé‡åˆ°çš„æ¯ä¸€ä¸ªå…³å¡ä»¥åŠéœ€è¦çš„é€šå…³æ‰‹å†Œã€‚

{{% tip %}}
åç»­æ‰€æœ‰çš„è®¨è®ºéƒ½æ˜¯åŸºäº CentOS7 64 ä½ Linux æ“ä½œç³»ç»Ÿç¯å¢ƒã€‚
{{% /tip %}}

æˆ‘ä»¬å…ˆæ¥ç¼–è¯‘ä¸Šé¢çš„ç¨‹åºï¼š

```bash
$ gcc hello.c -o hello
$ ./hello
hello, world
$ ll hello
-rwxr-xr-x 1 root root 16712 Nov 24 10:45 hello
```

æˆ‘ä»¬ä¼šå‘ç°è¿™ä¸ªç®€å•çš„ hello ç¨‹åºå¤§å°ä¸º 16Kï¼Œåœ¨ä»Šå¤©çœ‹æ¥ï¼Œ16K çœŸçš„æ²¡ä»€ä¹ˆï¼Œä½†æ˜¯è€ƒè™‘åˆ°è¿™ä¸ªç¨‹åºæ‰€åšçš„äº‹æƒ…ï¼Œå®ƒçœŸçš„éœ€è¦ 16K å—ï¼Ÿ

åœ¨ C è¯ç”Ÿçš„ä¸Šä¸ªä¸–çºª 70 å¹´ä»£ï¼ŒPDP-11 çš„å†…å­˜ä¸º 144Kï¼Œä¸€ä¸ª hello world å°±å äº† 16Kï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸åˆç†çš„ï¼Œä¸€å®šæœ‰åŠæ³•ç¼©å‡ä½“ç§¯ã€‚

{{% tip %}}
è¯´èµ· C è¯­è¨€ï¼Œæˆ‘æƒ³é¡ºå¸¦æä¸€ä¸‹ UNIXã€‚æ²¡æœ‰ C å°±æ²¡æœ‰ UNIX çš„æˆåŠŸï¼Œæ²¡æœ‰ UNIX çš„æˆåŠŸä¹Ÿå°±æ²¡æœ‰ C çš„ä»Šå¤©ã€‚è¯ç”Ÿäºä¸Šä¸ªä¸–çºª 70 å¹´ä»£çš„ UNIX ä¸å¾—ä¸è¯´æ˜¯ä¸€é¡¹äº†ä¸èµ·çš„åˆ›é€ ã€‚

è¿™é‡Œæ¨èä¸¤ä»½å…³äº UNIX çš„èµ„æ–™ï¼š

- [The UNIX Time-Sharing System](https://chsasank.github.io/classic_papers/unix-time-sharing-system.html) 1974 å¹´ç”± Dennis Ritchie å’Œ Ken Thompson è”åˆå‘è¡¨çš„ä»‹ç» UNIX çš„è®ºæ–‡ã€‚ä¸è¦è¢«â€œè®ºæ–‡â€äºŒå­—æ‰€å“åˆ°ï¼Œå®é™…ä¸Šï¼Œè¿™ç¯‡æ–‡ç« å†™å¾—éå¸¸é€šä¿—æ˜“æ‡‚ï¼Œç”± UNIX çš„ä½œè€…ä»¬å‘ä½ å¨“å¨“é“æ¥ UNIX çš„æ ¸å¿ƒè®¾è®¡ç†å¿µã€‚

- [The UNIX Operating System](https://www.youtube.com/watch?v=tc4ROCJYbm0&t=797s) ä¸€æ®µè§†é¢‘ï¼Œçœ‹èº«ç€è“è‰²æ—¶å°šæ¯›è¡£çš„ Kernighan æ¼”ç¤º UNIX çš„ç‰¹æ€§ï¼Œä¸å¾—ä¸è¯´ï¼ŒKernighan ç®€ç›´å¤ªå¸…äº†ã€‚
{{% /tip %}}

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ç©ä¸€ä¸ªæ¸¸æˆï¼Œç›®æ ‡æ˜¯ï¼šåœ¨ CentOS7 64 ä½æ“ä½œç³»ç»Ÿä¸Šï¼Œä¸€ä¸ªæ‰“å° hello world çš„å¯æ‰§è¡Œç¨‹åºæœ€å°å¯ä»¥åšåˆ°å¤šå°ï¼Ÿ

## Executable

æˆ‘ä»¬å…ˆæ¥çœ‹ã€Œå¯æ‰§è¡Œç¨‹åºã€è¿™ä¸ªæ¦‚å¿µã€‚

ä»€ä¹ˆæ˜¯å¯æ‰§è¡Œç¨‹åºï¼ŸæŒ‰ç…§å­—é¢æ„æ€æ¥ç†è§£ï¼Œé‚£å°±æ˜¯ï¼šå¯ä»¥æ‰§è¡Œçš„ç¨‹åºã€‚

### ELF

ä¸Šé¢ç”¨ C ç¼–å†™çš„ hello å½“ç„¶æ˜¯å¯æ‰§è¡Œç¨‹åºï¼Œæ¯«æ— ç–‘é—®ã€‚

å®é™…ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥è¯´å®ƒæ˜¯çœŸæ­£çš„â€œå¯æ‰§è¡Œâ€ç¨‹åºï¼ˆåŒºåˆ«äºåæ–‡çš„è„šæœ¬ï¼‰ï¼Œæˆ–è€…è¯´â€œåŸç”Ÿâ€ç¨‹åºã€‚

å› ä¸ºå®ƒé‡Œé¢åŒ…å«äº†å¯ä»¥ç›´æ¥ç”¨äº CPU æ‰§è¡Œçš„æœºå™¨ä»£ç ã€‚

hello çš„å­˜å‚¨æ ¼å¼å«åš ELFï¼Œå…¨ç§°ä¸º Executable and Linkable Formatã€‚

ELF åªæ˜¯ä¸€ä¸ªæ ¼å¼ï¼Œç”¨äºå­˜å‚¨ç›®æ ‡æ–‡ä»¶å’Œå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæœ¬èº«å¹¶ä¸éš¾ç†è§£ï¼Œ`/usr/include/elf.h` æ–‡ä»¶ä¸­å«æœ‰ ELF çš„å…·ä½“å®šä¹‰ä¿¡æ¯ã€‚

å…³äº ELF äº’è”ç½‘ä¸Šæœ‰å¾ˆå¤šèµ„æ–™ï¼Œè¿™é‡Œä¸å†å±•å¼€äº†ã€‚

### Shebang

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹å¦å¤–ä¸€ç§å½¢å¼çš„å¯æ‰§è¡Œç¨‹åºï¼Œè„šæœ¬ã€‚

```bash
$ cat > hello.sh <<EOF
#!/bin/bash
echo "hello, world"
EOF
$ chmod +x hello.sh
$ ./helo.sh
hello, world
```

æŒ‰ç…§å®šä¹‰ï¼Œå› ä¸ºè¿™ä¸ªè„šæœ¬å¯ä»¥ç›´æ¥ä»å‘½ä»¤è¡Œæ‰§è¡Œï¼Œæ‰€ä»¥å®ƒæ˜¯å¯æ‰§è¡Œç¨‹åºã€‚

é‚£ä¹ˆ hello å’Œ hello.sh çš„åŒºåˆ«åœ¨å“ªé‡Œï¼Ÿ

å¯ä»¥å‘ç° hello.sh çš„ç¬¬ä¸€è¡Œæ˜¯ä¸€ä¸ªå«åš Shebang çš„ä¸œè¥¿ `#!/bin/bash`ï¼Œè¿™ä¸ªä¸œè¥¿è¯´æ˜å½“å‰æ–‡ä»¶éœ€è¦ `/bin/bash` ç¨‹åºæ¥æ‰§è¡Œã€‚

æ‰€ä»¥ï¼Œhello å’Œ hello.sh çš„åŒºåˆ«å°±åœ¨äºï¼šä¸€ä¸ªå¯ä»¥ç›´æ¥æ‰§è¡Œä¸ä¾èµ–äºå¤–éƒ¨ç¨‹åºï¼Œè€Œä¸€ä¸ªéœ€è¦ä¾èµ–å¤–éƒ¨ç¨‹åºã€‚

æˆ‘æ›¾ç»æœ‰ä¸€ä¸ªè¯¯è§£ï¼Œè®¤ä¸º Shebang æ˜¯ Shell åœ¨å¤„ç†ï¼Œå½“ Shell æ‰§è¡Œè„šæœ¬æ—¶ï¼Œå‘ç°ç¬¬ä¸€è¡Œæ˜¯ Shebangï¼Œç„¶åè°ƒç”¨ç›¸åº”çš„ç¨‹åºæ¥æ‰§è¡Œè¯¥è„šæœ¬ã€‚

å®é™…ä¸Šå¹¶ä¸æ˜¯è¿™æ ·ï¼Œå¯¹ Shebang çš„å¤„ç†æ˜¯å†…æ ¸åœ¨è¿›è¡Œã€‚å½“å†…æ ¸åŠ è½½ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œä¼šé¦–å…ˆè¯»å–æ–‡ä»¶çš„å‰ 128 ä¸ªå­—èŠ‚ï¼Œæ ¹æ®è¿™ 128 ä¸ªå­—èŠ‚åˆ¤æ–­æ–‡ä»¶çš„ç±»å‹ï¼Œç„¶åè°ƒç”¨ç›¸åº”çš„åŠ è½½å™¨æ¥åŠ è½½ã€‚

æ¯”å¦‚è¯´ï¼Œå‘ç°æ˜¯ä¸€ä¸ª ELF æ–‡ä»¶ï¼ˆELF æ–‡ä»¶å‰å››ä¸ªå­—èŠ‚ä¸ºå›ºå®šå€¼ï¼Œç§°ä¸ºé­”æ•°ï¼‰ï¼Œé‚£ä¹ˆå°±è°ƒç”¨ ELF åŠ è½½å™¨ã€‚

è€Œå‘ç°å«æœ‰ Shebangï¼Œé‚£ä¹ˆå°±å¯åŠ¨ Shebang æŒ‡å®šçš„ç¨‹åºï¼Œå°†å½“å‰è·¯å¾„ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥ã€‚æ‰€æœ‰æˆ‘ä»¬æ‰§è¡Œ `./hello.sh` æ—¶ï¼Œåœ¨å†…æ ¸ä¸­ä¼šè¢«ä¿®æ”¹ä¸º `/bin/bash ./hello.sh`ã€‚

è¿™é‡Œå…¶å®æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœè¦è„šæœ¬å¯æ‰§è¡Œï¼Œé‚£ä¹ˆç¬¬ä¸€è¡Œå¿…é¡»æ˜¯ Shebangã€‚Shebang çš„å½¢å¼å›ºå®šä¸º `#!` å¼€å¤´ï¼Œå¯¹äºä½¿ç”¨ # å­—ç¬¦ä½œä¸ºæ³¨é‡Šçš„è¯­è¨€æ¯”å¦‚ Python, Elixir æ¥è¯´ï¼Œè¿™è‡ªç„¶ä¸æ˜¯é—®é¢˜ã€‚ä½†æ˜¯å¯¹äº # å­—ç¬¦ä¸æ˜¯æ³¨é‡Šå­—ç¬¦çš„è¯­è¨€æ¥è¯´ï¼Œè¿™ä¸€è¡Œå°±æ˜¯ä¸€ä¸ªéæ³•è¯­å¥ï¼Œå¿…ç„¶å¸¦æ¥è§£é‡Šé”™è¯¯ã€‚

æ¯”å¦‚ JavaScriptï¼Œå®ƒå°±ä¸ä½¿ç”¨ # ä½œä¸ºæ³¨é‡Šï¼Œæˆ‘ä»¬æ¥å†™ä¸€ä¸ªå¸¦ Shebang çš„ JS è„šæœ¬çœ‹çœ‹ä¼šæ€ä¹ˆæ ·ã€‚

```bash
$ cat <<EOF > test.js
#!/usr/bin/env node
console.log("hello world")
EOF
$ chmod +x test.js
$ ./test.js
hello world
```

å¹¶æ²¡æœ‰å‡ºç°é—®é¢˜ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯æ€ä¹ˆå›äº‹ï¼ŸæŒ‰é“ç†æ¥è¯´ç¬¬ä¸€è¡Œæ˜¯éæ³•çš„ JS è¯­å¥ï¼Œè§£é‡Šå™¨åº”è¯¥è¦æŠ¥é”™æ‰å¯¹ã€‚

å¦‚æœæŠŠç¬¬ä¸€è¡Œçš„ Shebang æ‹·è´åˆ°ç¬¬äºŒè¡Œï¼Œä¼šå‘ç°æŠ¥äº† `SyntaxError`ï¼Œè¿™æ‰æ˜¯ç¬¦åˆé¢„æœŸçš„ã€‚æ‰€ä»¥å¿…ç„¶æ˜¯ Node ä»€ä¹ˆåœ°æ–¹å¯¹ç¬¬ä¸€è¡Œçš„ Shebang åšäº†ç‰¹åˆ«å¤„ç†ï¼Œå¦åˆ™ä¸å¯èƒ½ã€‚

å¤§å®¶å¯ä»¥åœ¨ Node çš„ä»£ç é‡Œé¢æ‰¾ä¸€æ‰¾ï¼Œçœ‹çœ‹åœ¨ä»€ä¹ˆåœ°æ–¹ğŸ˜‰

ç­”æ¡ˆæ˜¯ä»€ä¹ˆåœ°æ–¹éƒ½æ²¡æœ‰ï¼Œæˆ–è€…è¯´åœ¨æœ€æ–°çš„ Node ä¸­ï¼Œå·²ç»æ²¡æœ‰åœ°æ–¹åœ¨å¤„ç† Shebang äº†ã€‚

åœ¨ Node v11 ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç›¸åº”çš„ä»£ç åœ¨ [è¿™é‡Œ](https://github.com/nodejs/node/blob/v11.15.0/lib/internal/main/check_syntax.js#L50)ã€‚

`stripShebang` å‡½æ•°å¾ˆæ˜æ˜¾ï¼Œå®ƒçš„ä½œç”¨åœ¨äºå¯åŠ¨ JS è§£é‡Šå™¨çš„æ—¶å€™ï¼Œå°†ç¬¬ä¸€è¡Œçš„ Shebang ç§»é™¤æ‰ã€‚

ä½†æ˜¯åœ¨ Node v12 ä»¥åï¼ŒNode æ›´æ–°äº† JS å¼•æ“ V8 åˆ° 7.4ï¼ŒV8 åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­å®ç°ä¸€ä¸ªå«åš [Hashbang grammar](https://v8.dev/blog/v8-release-74#hashbang-grammar)çš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä»æ­¤ä»¥åï¼ŒShebang çš„å‰¥ç¦»äº¤ç”± V8 æ¥å¤„ç†äº†ï¼Œå› æ­¤ Node åˆ é™¤äº†ç›¸å…³ä»£ç ã€‚

å› ä¸º Shebang æ˜¯ V8 åœ¨å¤„ç†äº†ï¼Œæˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸­ä¹Ÿå¯ä»¥åŠ è½½å¸¦æœ‰ Shebang çš„ JS æ–‡ä»¶ï¼Œä¸ä¼šæœ‰ä»»ä½•é—®é¢˜~

æˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼Œæ”¯æŒä½œä¸ºè„šæœ¬ä½¿ç”¨çš„è¯­è¨€ï¼Œå¦‚æœä¸ä½¿ç”¨ # ä½œä¸ºæ³¨é‡Šå­—ç¬¦ï¼Œé‚£ä¹ˆå¿…ç„¶è¦ç‰¹åˆ«å¤„ç† Shebangï¼Œå¦åˆ™ä½¿ç”¨èµ·æ¥å°±å¤ªä¸æ–¹ä¾¿äº†ã€‚

### /usr/bin/env

ä¸Šé¢çš„ test.js æ–‡ä»¶ä¸­ï¼Œä¸çŸ¥é“å¤§å®¶æ˜¯å¦æ³¨æ„åˆ°ï¼Œè§£é‡Šå™¨è·¯å¾„å†™çš„æ˜¯ `/usr/bin/env node`ã€‚

è¿™æ ·çš„å†™æ³•å¦‚æœç»å¸¸å†™è„šæœ¬ï¼Œåº”è¯¥ä¸é™Œç”Ÿï¼Œæˆ‘ä¹‹å‰ä¸€ç›´è¿™æ ·ç”¨ï¼Œä½†æ˜¯æ²¡æœ‰ä»”ç»†å»æ¢ç©¶è¿‡ä¸ºä»€ä¹ˆã€‚

é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ `/usr/bin/env` è¿™ä¸ªç¨‹åºæ˜¯ä»€ä¹ˆã€‚

æ ¹æ® `man env` è¿”å›çš„ä¿¡æ¯ï¼šenv - run a program in a modified environment.

`env` çš„ä¸»è¦ä½œç”¨ä¼¼ä¹æ˜¯ä¿®æ”¹ç¨‹åºè¿è¡Œçš„ç¯å¢ƒå˜é‡ï¼Œæ¯”å¦‚è¯´

```bash
$ export name=shell
$ node
> process.env.name
'shell'
$ env name=env node
> process.env.name
'env'
```

é€šè¿‡ env æˆ‘ä»¬ä¿®æ”¹äº† node è¿è¡Œæ—¶çš„ç¯å¢ƒå˜é‡ã€‚ä½†æ˜¯è¿™ä¸ªåŠŸèƒ½å’Œæˆ‘ä»¬ä¸ºä»€ä¹ˆè¦åœ¨ Shebang ä¸­ä½¿ç”¨ env å…¶å®å¹¶æ²¡æœ‰å…³ç³»ã€‚

åœ¨ Shebang ä¸­ä½¿ç”¨ env ä¸»è¦æ˜¯å› ä¸ºå¦å¤–ä¸€ä¸ªåŸå› ï¼Œé‚£å°±æ˜¯ env ä¼šåœ¨ PATH ä¸­æœç´¢ç¨‹åºå¹¶æ‰§è¡Œã€‚

å½“æˆ‘ä»¬æ‰§è¡Œ `env abc` æ—¶ï¼Œenv ä¼šåœ¨ PATH ä¸­æœç´¢ abc ç„¶åæ‰§è¡Œï¼Œå°±å’Œ Shell ä¸€æ ·ã€‚

è¿™å°±è§£é‡Šäº†ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨è„šæœ¬ä¸­ä½¿ç”¨ `/usr/bin/env node`ã€‚å¯¹äºæƒ³è¦ç»™ä»–äººå¤ç”¨çš„è„šæœ¬ï¼Œæˆ‘ä»¬å¹¶ä¸æ¸…æ¥šä»–äººç³»ç»Ÿä¸Š node çš„è·¯å¾„åœ¨å“ªé‡Œï¼Œä½†æ˜¯æˆ‘ä»¬æ¸…æ¥šçš„æ˜¯ï¼Œå®ƒä¸€å®šåœ¨ PATH ä¸­ã€‚

è€ŒåŒæ—¶ï¼Œç»å¤§éƒ¨åˆ†ç³»ç»Ÿä¸Šï¼Œ`env` ç¨‹åºçš„ä½ç½®æ˜¯å›ºå®šçš„ï¼Œé‚£å°±æ˜¯ `/usr/bin/env`ã€‚æ‰€ä»¥ï¼Œé€šè¿‡ä½¿ç”¨ `/usr/bin/env node`ï¼Œæˆ‘ä»¬å¯ä»¥ä¿è¯ä¸ç®¡å…¶ä»–ç”¨æˆ·å°† node å®‰è£…åœ¨ä½•å¤„ï¼Œè¿™ä¸ªè„šæœ¬éƒ½å¯ä»¥å¾—åˆ°æ­£ç¡®æ‰§è¡Œã€‚

### binfmt_misc

å‰é¢æˆ‘ä»¬æåˆ°è¿‡ï¼Œå†…æ ¸å¯¹äºæ–‡ä»¶çš„åŠ è½½å…¶å®æ˜¯æœ‰ä¸€å¥—â€œå¤šæ€â€œæœºåˆ¶çš„ï¼Œå³æ ¹æ®ä¸åŒçš„ç±»å‹æ¥é€‰æ‹©ä¸åŒçš„åŠ è½½å™¨ã€‚

é‚£ä¹ˆè¿™ä¸ªè¿‡ç¨‹æˆ‘ä»¬å¯ä»¥è‡ªå·±å®šåˆ¶å—ï¼Ÿå½“ç„¶å¯ä»¥ã€‚

å†…æ ¸ä¸­æœ‰ä¸€ä¸ªåŠ è½½å™¨å«åš `binfmt_misc`ï¼Œçœ‹åå­—å¯ä»¥çŸ¥é“ï¼Œè¿™ä¸ªåŠ è½½å™¨ç”¨äºå¤„ç†å„ç§å„æ ·éæ ‡å‡†çš„å…¶ä»–ç±»å‹ã€‚

é€šè¿‡ä¸€å¥— [è¯­æ³•](https://www.kernel.org/doc/Documentation/admin-guide/binfmt-misc.rst)ï¼Œæˆ‘ä»¬å¯ä»¥å‘ŠçŸ¥ binfmt_misc åŠ è½½è§„åˆ™ï¼Œå®ç°è‡ªå®šä¹‰çš„åŠ è½½ã€‚

æ¯”å¦‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ binfmt_misc å®ç°ç›´æ¥è¿è¡Œ Go æ–‡ä»¶ã€‚

```bash
# è¿è¡Œ Go æ–‡ä»¶çš„æŒ‡ä»¤æ˜¯ `go run`ï¼Œä¸æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç¨‹åº
# æ‰€ä»¥ï¼Œæˆ‘ä»¬å…ˆè¦å†™ä¸€ä¸ªè„šæœ¬åŒ…è£…ä¸€ä¸‹
$ cat <<EOF > /usr/local/bin/rungo
#!/bin/bash
go run $1
EOF
# æ¥ä¸‹æ¥å†™å…¥è§„åˆ™å‘Šè¯‰ binfmt_misc ä½¿ç”¨ä¸Šé¢çš„ç¨‹åºæ¥åŠ è½½æ‰€æœ‰
# ä»¥ .go ç»“å°¾çš„æ–‡ä»¶
$ echo ':golang:E::go::/usr/local/bin/rungo:' > /proc/sys/fs/binfmt_misc/register
# ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥è¿è¡Œ Go æ–‡ä»¶äº†
$ cat << EOF > test.go
package main
import "fmt"

func main() {
  fmt.Println("hello, world")
}
EOF
$ chmod +x test.go
$ ./test.go
hello, world
```

### Tiny Script

æ ¹æ®ä¸Šé¢çš„çŸ¥è¯†ï¼Œå¦‚æœæ˜¯è„šæœ¬çš„è¯ï¼Œæƒ³è¦åšåˆ°ä½“ç§¯å°½å¯èƒ½å°ï¼Œåº”è¯¥è¦æ»¡è¶³ä¸€ä¸‹ä¸¤ç‚¹

- è§£é‡Šå™¨è·¯å¾„è¦çŸ­
- è„šæœ¬æœ¬èº«ç”¨äºæ‰“å°çš„ä»£ç è¦å°½é‡çŸ­

è§£é‡Šå™¨çš„è·¯å¾„å¾ˆå¥½å¤„ç†ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨é“¾æ¥ã€‚

è„šæœ¬æœ¬èº«çš„ä»£ç è¦çŸ­ï¼Œæˆ‘æƒ³åˆ°çš„æ˜¯ PHPï¼ŒPHP æ‰“å° hello world çš„ä»£ç æ˜¯ `hello, world`ï¼Œå¯¹çš„ï¼Œä½ æ²¡çœ‹é”™ï¼Œè¿å¼•å·éƒ½ä¸ç”¨ã€‚

æ‰€ä»¥ï¼Œæœ€ç»ˆæˆ‘ä»¬å¾—åˆ°çš„ç»“æœå¦‚ä¸‹ï¼š

```bash
# å‡è®¾ php åœ¨ /usr/local/bin/php
$ cd /
$ ln -s /usr/local/bin/php p
$ cat <<EOF > final.php
#!/p
hello, world
EOF
$ chmod +x final.php
$ ./final.php
hello, world
$ ll final.php
-rwxr-xr-x 1 root root 18 Dec  2 22:32 final.php
```

åœ¨è„šæœ¬æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬çš„æˆç»©æ˜¯ 18 ä¸ªå­—èŠ‚ï¼Œä½¿ç”¨çš„è§£é‡Šå™¨æ˜¯ PHPã€‚

## Tiny Native

ä¸Šé¢å¾—åˆ°çš„æ˜¯é’ˆå¯¹è„šæœ¬çš„ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹ï¼Œå¯¹äºåŸç”Ÿå¯æ‰§è¡Œç¨‹åºï¼Œæœ€å°çš„ä½“ç§¯èƒ½å¤Ÿåšåˆ°å¤šå°ã€‚

### step0

é¦–å…ˆï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸Šæ–‡æåˆ°çš„ hello.c ä½œä¸ºåŸºå‡†ç¨‹åºã€‚

```c
// hello.c
#include <stdio.h>

int main() {
  printf("hello, world\n");
  return 0;
}
```

`gcc hello.c -o hello.out` ç¼–è¯‘ä»¥åï¼Œå®ƒçš„å¤§å°æ˜¯ 16712 ä¸ªå­—èŠ‚ã€‚

### step1: strip

ç¬¬ä¸€æ­¥ï¼Œä¹Ÿæ˜¯æœ€æœ€å®¹æ˜“æƒ³åˆ°çš„ä¸€æ­¥ï¼Œå‰”é™¤ç¬¦å·è¡¨ã€‚

ç¬¦å·æ˜¯é“¾æ¥å™¨å·¥ä½œçš„çš„åŸºæœ¬å…ƒç´ ï¼Œæˆ‘ä»¬æºä»£ç ä¸­å‡½æ•°ã€å˜é‡ç­‰è¢«ç¼–è¯‘ä»¥åï¼Œéƒ½å˜æˆäº†ç¬¦å·ã€‚

å¦‚æœç»å¸¸ä»äº‹ C å¼€å‘ï¼Œä¸€å®šé‡åˆ°è¿‡ `ld: symbol not found` çš„é”™è¯¯ï¼Œå¾€å¾€æ˜¯å¿˜è®°é“¾æ¥äº†æŸä¸ªåº“å¯¼è‡´çš„ã€‚

ä½¿ç”¨ `nm` æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ä¸€ä¸ªäºŒè¿›åˆ¶ç¨‹åºä¸­å«æœ‰å“ªäº›ç¬¦å·ã€‚

å¯¹ step0 ä¸­çš„ hello.out ç¨‹åºä½¿ç”¨ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š

```
$ nm hello.out
0000000000404038 B __bss_start
0000000000404038 b completed.6949
0000000000404028 D __data_start
0000000000404028 W data_start
0000000000401090 t deregister_tm_clones
0000000000401110 t __do_global_dtors_aux
0000000000403df8 d __do_global_dtors_aux_fini_array_entry
0000000000404030 D __dso_handle
0000000000403e08 d _DYNAMIC
0000000000404038 D _edata
0000000000404040 B _end
00000000004011e4 T _fini
0000000000401130 t frame_dummy
0000000000403df0 d __frame_dummy_init_array_entry
0000000000402154 r __FRAME_END__
0000000000404000 d _GLOBAL_OFFSET_TABLE_
                 w __gmon_start__
0000000000402014 r __GNU_EH_FRAME_HDR
0000000000401000 T _init
0000000000403df8 d __init_array_end
0000000000403df0 d __init_array_start
0000000000402000 R _IO_stdin_used
0000000000403e00 d __JCR_END__
0000000000403e00 d __JCR_LIST__
00000000004011e0 T __libc_csu_fini
0000000000401170 T __libc_csu_init
                 U __libc_start_main@@GLIBC_2.2.5
0000000000401156 T main
                 U puts@@GLIBC_2.2.5
00000000004010d0 t register_tm_clones
0000000000401060 T _start
0000000000404038 D __TMC_END__
```

å¯ä»¥çœ‹åˆ°ä¸€ä¸ªç¬¦å·å«åš `main`ï¼Œè¿™ä¸ªå¯¹åº”çš„å°±æ˜¯æˆ‘ä»¬çš„ main å‡½æ•°ã€‚ä½†æ˜¯å¾ˆå¥‡æ€ªæ²¡æœ‰çœ‹åˆ° `printf`ï¼Œè€Œæ˜¯å‡ºç°äº†ä¸€ä¸ªå«åš `puts@@GLIBC_2.2.5` çš„ç¬¦å·ã€‚

è¿™é‡Œæ˜¯ GCC åšçš„ä¸€ä¸ªä¼˜åŒ–ï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨æ ¼å¼å­—ç¬¦ä¸²è°ƒç”¨ `printf`ï¼ŒGCC ä¼šå°†å®ƒæ¢æˆ `puts`ã€‚

è¿™äº›ç¬¦å·éƒ½å­˜å‚¨åœ¨äº† ELF ä¸­ï¼Œå¯¹äºå¯æ‰§è¡Œæ–‡ä»¶æ¥è¯´ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆå¤ªå¤§ä½œç”¨ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é¦–å…ˆé€šè¿‡å‰”é™¤ç¬¦å·è¡¨æ¥èŠ‚çœç©ºé—´ã€‚

æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œç¬¬ä¸€æ˜¯é€šè¿‡ `strip` ç¨‹åºï¼Œç¬¬äºŒæ˜¯é€šè¿‡ GCC çš„å‚æ•°ã€‚

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ç¬¬äºŒä¸ªæ–¹æ³•ï¼Œ`gcc -s hello.c -o hello.out` å¾—åˆ°æ–°çš„å¯æ‰§è¡Œç¨‹åºï¼Œå®ƒçš„å¤§å°æ˜¯ 14512 å­—èŠ‚ã€‚

### step2: optimization

step1
  size: 14512
  é¦–å…ˆï¼Œ strip ç§»é™¤ç¬¦å·è¡¨ã€‚ gcc -s hello.c -o hello2

step2
  å¼€å¯ä¼˜åŒ– gcc -s -O3 hello.c -o hello3
  size: 14512

step3:
  ç§»é™¤å¯åŠ¨æ–‡ä»¶
  https://stackoverflow.com/questions/5422831/what-is-the-difference-between-using-exit-exit-in-a-conventional-linux-fo
  size: 13664

step4:
  ç§»é™¤æ ‡å‡†åº“

  https://github.com/torvalds/linux/blob/v3.13/arch/x86/syscalls/syscall_64.tbl

  https://www.briansteffens.com/introduction-to-64-bit-assembly/01-hello-world/

  https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/

  inline assembly: https://www.ibiblio.org/gferg/ldp/GCC-Inline-Assembly-HOWTO.html

  x64 assembly: https://cs.brown.edu/courses/cs033/docs/guides/x64_cheatsheet.pdf

  size: 12912

step5: é“¾æ¥è„šæœ¬
  size: 584

step6: nasm
  size: 440

step7: handmade elf
  https://elfy.io/
  size: 170

  elf header: 64
  program header: 56

```
```


